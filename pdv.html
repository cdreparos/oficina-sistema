<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>PDV - Venda R√°pida - SIGO</title>
  
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <style>
    :root {
      --sidebar-bg: #1e293b; --main-bg: #e2e8f0; --card-bg: #ffffff;
      --text-primary: #1e293b; --text-secondary: #64748b;
      --accent-purple: #8b5cf6; --accent-green: #10b981; --accent-red: #ef4444;
      --border-color: #e2e8f0;
    }
    body.dark-mode {
        --main-bg: #0f172a; --card-bg: #1e293b; --text-primary: #f1f5f9;
        --text-secondary: #94a3b8; --border-color: #334155;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: var(--main-bg); color: var(--text-primary); height: 100vh; overflow: hidden; }
    
    /* Layout Desktop Padr√£o */
    .pdv-container { display: grid; grid-template-columns: 240px 1fr 400px; height: 100vh; }
    
    /* Sidebar (PC) - CORRE√á√ÉO DA LOGO AQUI */
    .sidebar { background: var(--sidebar-bg); color: #fff; display: flex; flex-direction: column; padding: 24px 16px; height: 100%; z-index: 100; }
    .sidebar-header { display: flex; align-items: center; gap: 12px; margin-bottom: 30px; }
    .sidebar-logo { 
        width: auto; min-width: 40px; padding: 0 8px; /* Ajuste para caber "PDV" */
        height: 40px; background: var(--accent-purple); border-radius: 10px; 
        display: flex; align-items: center; justify-content: center; 
        font-size: 1.2rem; font-weight: bold; 
    }
    .nav-list { list-style: none; }
    .back-btn { margin-top: auto; background: rgba(255,255,255,0.1); border: none; color: white; padding: 12px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 1rem; width: 100%; }
    .back-btn:hover { background: var(--accent-red); }

    /* √Årea Central (Vitrine) */
    .vitrine-area { padding: 24px; display: flex; flex-direction: column; height: 100%; overflow: hidden; }
    .search-container { display: flex; gap: 10px; margin-bottom: 20px; }
    .search-bar { position: relative; flex-grow: 1; }
    .search-bar input { width: 100%; padding: 16px 20px 16px 50px; border: 2px solid var(--border-color); border-radius: 12px; font-size: 1.1rem; background: var(--card-bg); color: var(--text-primary); transition: all 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
    .search-bar input:focus { outline: none; border-color: var(--accent-purple); box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1); }
    .search-icon { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); font-size: 1.2rem; color: var(--text-secondary); }
    
    .btn-scan {
        background: var(--accent-purple); color: white; border: none; border-radius: 12px; width: 56px; cursor: pointer; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; transition: transform 0.2s;
    }
    .btn-scan:hover { transform: scale(1.05); background: #7c3aed; }
    
    .produtos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; overflow-y: auto; padding-right: 8px; flex-grow: 1; padding-bottom: 100px; } 
    .produto-card { background: var(--card-bg); border-radius: 12px; padding: 16px; border: 1px solid var(--border-color); cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; justify-content: space-between; position: relative; overflow: hidden; height: 160px; }
    .produto-card:hover { transform: translateY(-4px); border-color: var(--accent-purple); box-shadow: 0 10px 15px rgba(0,0,0,0.05); }
    .produto-nome { font-weight: 600; font-size: 0.95rem; margin-bottom: 8px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
    .produto-info { margin-top: auto; }
    .produto-preco { font-size: 1.2rem; font-weight: 700; color: var(--accent-purple); }
    .produto-estoque { font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px; }
    .add-icon { position: absolute; bottom: 12px; right: 12px; background: var(--accent-purple); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; opacity: 0; transition: all 0.2s; transform: scale(0.5); }
    .produto-card:hover .add-icon { opacity: 1; transform: scale(1); }
    .estoque-baixo { color: var(--accent-red); font-weight: bold; }

    /* √Årea Carrinho (Desktop) */
    .carrinho-area { background: var(--card-bg); border-left: 1px solid var(--border-color); display: flex; flex-direction: column; height: 100%; box-shadow: -4px 0 20px rgba(0,0,0,0.05); z-index: 50; }
    .carrinho-header { padding: 24px; border-bottom: 1px solid var(--border-color); background: var(--main-bg); }
    
    /* NOVO: Seletor de Modo de Venda */
    .sale-mode-switch {
        display: flex; background: var(--card-bg); border: 1px solid var(--border-color);
        border-radius: 8px; overflow: hidden; margin-bottom: 16px;
    }
    .sale-mode-option {
        flex: 1; padding: 10px; text-align: center; cursor: pointer; font-weight: 600; font-size: 0.9rem;
        transition: all 0.2s; border-bottom: 3px solid transparent;
    }
    .sale-mode-option.active {
        background: rgba(139, 92, 246, 0.1); color: var(--accent-purple); border-bottom-color: var(--accent-purple);
    }

    /* NOVO: Estilo para Busca de OS */
    .os-selector-container {
        display: none; /* Escondido por padr√£o */
        margin-bottom: 16px; position: relative;
    }
    .os-selector-container.show { display: block; }
    .os-search-input {
        width: 100%; padding: 12px; border: 2px solid var(--accent-purple); border-radius: 8px;
        background: var(--card-bg); color: var(--text-primary);
    }
    .os-list-dropdown {
        position: absolute; top: 100%; left: 0; right: 0; background: var(--card-bg);
        border: 1px solid var(--border-color); border-radius: 8px; max-height: 250px;
        overflow-y: auto; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .os-item-drop {
        padding: 12px; border-bottom: 1px solid var(--border-color); cursor: pointer;
        display: flex; justify-content: space-between; align-items: center;
    }
    .os-item-drop:hover { background: var(--main-bg); }
    .os-item-tag { 
        font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; background: #e2e8f0; color: #64748b; 
    }
    .selected-os-display {
        background: #dbeafe; color: #1e40af; padding: 12px; border-radius: 8px; 
        margin-bottom: 16px; display: none; align-items: center; justify-content: space-between;
    }
    .btn-remove-os { background: none; border: none; font-weight: bold; cursor: pointer; color: #1e40af; }

    /* Cliente Search (mantido para venda balc√£o) */
    .cliente-search { position: relative; margin-bottom: 10px; }
    .cliente-search input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-primary); font-size: 0.95rem; }
    .cliente-suggestions { position: absolute; top: 100%; left: 0; right: 0; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none; }
    .cliente-suggestions.show { display: block; }
    .suggestion-item { padding: 10px 14px; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: background 0.2s; }
    .suggestion-item:hover { background: var(--main-bg); }
    
    .carrinho-lista { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
    .carrinho-item { display: flex; justify-content: space-between; align-items: center; background: var(--main-bg); padding: 12px; border-radius: 10px; animation: slideIn 0.3s ease; }
    .item-info { flex-grow: 1; }
    .item-nome { font-weight: 600; font-size: 0.9rem; margin-bottom: 4px; }
    .item-preco { font-size: 0.85rem; color: var(--text-secondary); }
    .item-qtd-control { display: flex; align-items: center; gap: 10px; margin: 0 16px; background: var(--card-bg); padding: 4px; border-radius: 6px; }
    .btn-qtd { width: 24px; height: 24px; border: none; background: transparent; color: var(--text-primary); cursor: pointer; font-weight: bold; border-radius: 4px; }
    .btn-qtd:hover { background: var(--border-color); }
    .item-qtd { font-weight: 600; font-size: 0.9rem; width: 20px; text-align: center; }
    .item-total { font-weight: 700; color: var(--text-primary); font-size: 0.95rem; min-width: 70px; text-align: right; }
    .btn-remove { color: var(--text-secondary); background: none; border: none; cursor: pointer; padding: 4px; margin-left: 8px; transition: color 0.2s; }
    .btn-remove:hover { color: var(--accent-red); }
    
    .carrinho-footer { padding: 24px; border-top: 1px solid var(--border-color); background: var(--card-bg); }
    .resumo-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-secondary); }
    .resumo-row.total { font-size: 1.5rem; font-weight: 800; color: var(--text-primary); margin-top: 16px; margin-bottom: 24px; align-items: center; }
    .input-desconto { width: 80px; padding: 4px 8px; border: 1px solid var(--border-color); border-radius: 4px; text-align: right; background: var(--main-bg); color: var(--text-primary); }
    .pagamento-select { width: 100%; padding: 12px; border-radius: 8px; border: 2px solid var(--border-color); background: var(--main-bg); color: var(--text-primary); font-size: 1rem; margin-bottom: 16px; font-weight: 500; cursor: pointer; }
    .btn-finalizar { width: 100%; padding: 16px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3); display: flex; justify-content: center; align-items: center; gap: 10px; }
    .btn-finalizar:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(124, 58, 237, 0.4); }
    .btn-finalizar:disabled { background: var(--text-secondary); cursor: not-allowed; opacity: 0.5; box-shadow: none; }

    /* --- MOBILE HEADER & TABS --- */
    .mobile-header-container { display: none; } 

    .mobile-header-fixed {
        position: fixed; top: 0; left: 0; right: 0;
        background: var(--sidebar-bg); color: white;
        padding: 12px 16px; z-index: 900;
        display: flex; align-items: center; justify-content: space-between;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .mobile-header-fixed h2 { font-size: 1.1rem; margin: 0; }
    .mobile-back-btn {
        background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 12px; border-radius: 6px; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 6px;
    }

    .mobile-tabs {
        position: fixed; top: 55px; left: 0; right: 0;
        background: var(--card-bg); z-index: 890;
        display: flex; border-bottom: 1px solid var(--border-color);
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .mobile-tab {
        flex: 1; padding: 12px; border: none; background: none;
        font-weight: 600; color: var(--text-secondary);
        font-size: 0.95rem; cursor: pointer;
        border-bottom: 3px solid transparent;
        transition: all 0.2s;
    }
    .mobile-tab.active {
        color: var(--accent-purple);
        border-bottom-color: var(--accent-purple);
        background: rgba(139, 92, 246, 0.05);
    }
    .badge-count {
        background: var(--accent-red); color: white;
        padding: 2px 6px; border-radius: 10px; font-size: 0.75rem; margin-left: 4px;
        vertical-align: middle;
    }

    /* --- MODAL SCANNER --- */
    #scannerModal {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.95); z-index: 2000; flex-direction: column; align-items: center; justify-content: center;
    }
    #scannerModal.active { display: flex; }
    
    .scanner-wrapper { position: relative; width: 100%; max-width: 500px; }
    #reader { width: 100%; background: black; border-radius: 12px; overflow: hidden; }
    
    #scanSuccessOverlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(16, 185, 129, 0.95);
        display: none; flex-direction: column; align-items: center; justify-content: center;
        color: white; text-align: center; z-index: 10; border-radius: 12px;
    }
    #scanSuccessOverlay.show { display: flex; }
    
    .scan-msg { font-size: 1.2rem; font-weight: bold; margin-bottom: 20px; padding: 0 20px; }
    .btn-proximo {
        background: white; color: #10b981; border: none; padding: 15px 30px;
        font-size: 1.1rem; font-weight: bold; border-radius: 30px; cursor: pointer;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .btn-fechar-scanner {
        margin-top: 20px; padding: 10px 20px; background: rgba(255,255,255,0.2); 
        color: white; border: 1px solid white; border-radius: 20px; font-weight: bold; cursor: pointer;
    }

    /* --- CUPOM FISCAL --- */
    #cupomFiscal { display: none; }
    @media print {
        body * { visibility: hidden; }
        .pdv-container, .sidebar, .mobile-menu-btn, .mobile-header-container { display: none !important; }
        #cupomFiscal, #cupomFiscal * { visibility: visible; }
        #cupomFiscal { display: block; position: absolute; left: 0; top: 0; width: 100%; max-width: 80mm; padding: 10px; font-family: 'Courier New', Courier, monospace; color: black; background: white; }
        .cupom-header { text-align: center; border-bottom: 1px dashed #000; padding-bottom: 10px; margin-bottom: 10px; }
        .cupom-table { width: 100%; font-size: 0.85rem; border-collapse: collapse; margin-bottom: 10px; }
        .cupom-table th { text-align: left; border-bottom: 1px dashed #000; padding: 5px 0; }
        .cupom-table td { padding: 4px 0; vertical-align: top; }
        .text-right { text-align: right; }
        .cupom-totais { border-top: 1px dashed #000; padding-top: 10px; font-size: 0.9rem; }
        .cupom-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .cupom-total-final { font-weight: bold; font-size: 1.1rem; margin-top: 5px; }
        .cupom-footer { text-align: center; margin-top: 20px; font-size: 0.8rem; border-top: 1px dashed #000; padding-top: 10px; }
    }

    /* --- MOBILE LOGIC --- */
    @media (max-width: 768px) { 
        body { height: auto; overflow-y: auto; padding-bottom: 220px; background: var(--main-bg); }
        .pdv-container { display: block; height: auto; padding-top: 110px; }
        .sidebar { display: none; }
        .mobile-header-container { display: block; }

        .vitrine-area { display: none; height: auto; overflow: visible; padding: 16px; }
        .vitrine-area.active { display: block; }

        .carrinho-area { display: none; height: auto; border: none; box-shadow: none; background: transparent; }
        .carrinho-area.active { display: block; }
        
        .carrinho-header { padding: 16px; background: var(--card-bg); border-radius: 12px; margin: 0 16px 16px 16px; border: 1px solid var(--border-color); }
        .carrinho-lista { padding: 0 16px; overflow: visible; }
        
        .carrinho-footer {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--card-bg); border-top: 1px solid var(--border-color);
            padding: 16px; z-index: 800; box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            max-height: 220px; overflow-y: auto; display: none; 
        }
        .carrinho-area.active + .carrinho-footer, 
        .carrinho-footer.active { display: block; }

        .resumo-row { font-size: 0.85rem; margin-bottom: 4px; }
        .pagamento-select { padding: 8px; margin-bottom: 8px; }
        .btn-finalizar { padding: 12px; font-size: 1rem; }
    }
  </style>
</head>
<body>

  <div class="mobile-header-container">
      <header class="mobile-header-fixed">
          <button class="mobile-back-btn" onclick="window.location.href='painel.html'">‚¨Ö Painel</button>
          <h2>Venda R√°pida</h2>
          <div style="width: 60px;"></div> 
      </header>
      
      <div class="mobile-tabs">
          <button class="mobile-tab active" onclick="mudarAbaMobile('vitrine')">üì¶ Produtos</button>
          <button class="mobile-tab" onclick="mudarAbaMobile('carrinho')">üõí Carrinho <span id="badgeCarrinho" class="badge-count" style="display:none">0</span></button>
      </div>
  </div>

  <div class="pdv-container">
    <nav class="sidebar">
      <div class="sidebar-header"><div class="sidebar-logo">PDV</div><h1>Venda R√°pida</h1></div>
      <div style="flex-grow: 1;"></div>
      <button class="back-btn" onclick="window.location.href='painel.html'"><span>‚¨Ö</span> Voltar ao Painel</button>
    </nav>

    <main class="vitrine-area active" id="tabVitrine">
      <div class="search-container">
        <div class="search-bar">
            <span class="search-icon">üîç</span>
            <input type="text" id="searchProduto" placeholder="Buscar pe√ßa ou c√≥digo..." autofocus>
        </div>
        <button class="btn-scan" onclick="abrirScanner()">üì∑</button>
      </div>
      <div class="produtos-grid" id="produtosGrid"></div>
    </main>

    <aside class="carrinho-area" id="tabCarrinho">
      <div class="carrinho-header">
        
        <div class="sale-mode-switch">
            <div class="sale-mode-option active" id="modeBalcao" onclick="setSaleMode('balcao')">üõí Balc√£o</div>
            <div class="sale-mode-option" id="modeOS" onclick="setSaleMode('os')">üõ†Ô∏è Alocar OS</div>
        </div>

        <div id="divClientSearch">
            <h3 style="margin-bottom: 12px; color: var(--text-primary);">üë§ Cliente</h3>
            <div class="cliente-search">
                <input type="text" id="clienteInput" placeholder="Nome do Cliente (Opcional)">
                <input type="hidden" id="clienteId">
                <div class="cliente-suggestions" id="clienteSuggestions"></div>
            </div>
        </div>

        <div id="divOSSearch" style="display:none;">
            <h3 style="margin-bottom: 12px; color: var(--text-primary);">üõ†Ô∏è Vincular OS</h3>
            
            <div id="selectedOSDisplay" class="selected-os-display">
                <span id="txtSelectedOS">OS #000 - Cliente</span>
                <button class="btn-remove-os" onclick="limparSelecaoOS()">‚úï</button>
            </div>

            <div id="osInputContainer" class="os-selector-container show">
                <input type="text" id="osSearchInput" class="os-search-input" placeholder="Buscar OS (Nome ou N¬∫)...">
                <div id="osListDropdown" class="os-list-dropdown"></div>
            </div>
        </div>

      </div>
      
      <div class="carrinho-lista" id="carrinhoLista">
        <div style="text-align: center; color: var(--text-secondary); margin-top: 40px;"><p style="font-size: 3rem; margin-bottom: 10px;">üõí</p><p>Seu carrinho est√° vazio</p></div>
      </div>
      
      <div class="carrinho-footer" id="footerCarrinho">
        <div class="resumo-row"><span>Subtotal</span><span id="lblSubtotal">R$ 0,00</span></div>
        <div class="resumo-row" style="align-items: center;"><span>Desconto</span><input type="number" id="inputDesconto" class="input-desconto" placeholder="0,00" min="0" step="0.01"></div>
        <div class="resumo-row total"><span>TOTAL</span><span id="lblTotal" style="color: var(--accent-purple);">R$ 0,00</span></div>
        
        <div id="divPagamento">
            <select class="pagamento-select" id="formaPagamento">
                <option value="Dinheiro">üíµ Dinheiro</option>
                <option value="PIX">üí† PIX</option>
                <option value="Cart√£o de D√©bito">üí≥ Cart√£o de D√©bito</option>
                <option value="Cart√£o de Cr√©dito">üí≥ Cart√£o de Cr√©dito</option>
            </select>
        </div>

        <button class="btn-finalizar" id="btnFinalizar" onclick="finalizarVenda()">‚úÖ Finalizar Venda</button>
      </div>
    </aside>
  </div>

  <div id="scannerModal">
      <div style="color: white; margin-bottom: 10px; font-size: 1.2rem;">Aponte para o QR Code</div>
      <div class="scanner-wrapper">
          <div id="reader"></div>
          <div id="scanSuccessOverlay">
              <div class="scan-msg" id="scanMsg">Produto Adicionado!</div>
              <button class="btn-proximo" onclick="lerProximo()">üì∏ Ler Pr√≥ximo</button>
          </div>
      </div>
      <button class="btn-fechar-scanner" onclick="fecharScanner()">Fechar C√¢mera</button>
  </div>

  <div id="cupomFiscal">
      <div class="cupom-header"><div class="cupom-empresa">SIGO CASA DOS REPAROS</div><div class="cupom-info">Montanha, ES</div><div class="cupom-info" id="cupomData"></div></div>
      <div style="margin-bottom: 10px; font-size: 0.9rem;"><strong>Cliente:</strong> <span id="cupomCliente"></span></div>
      <table class="cupom-table"><thead><tr><th>Item</th><th class="text-right">Qtd</th><th class="text-right">Valor</th></tr></thead><tbody id="cupomItens"></tbody></table>
      <div class="cupom-totais">
          <div class="cupom-row"><span>Subtotal:</span> <span id="cupomSubtotal"></span></div>
          <div class="cupom-row"><span>Desconto:</span> <span id="cupomDesconto"></span></div>
          <div class="cupom-row cupom-total-final"><span>TOTAL:</span> <span id="cupomTotal"></span></div>
          <div class="cupom-row" style="margin-top: 5px;"><span>Forma Pagto:</span> <span id="cupomPagamento"></span></div>
      </div>
      <div class="cupom-footer"><p>*** N√ÉO √â DOCUMENTO FISCAL ***</p><p>Obrigado pela prefer√™ncia!</p><p>Volte Sempre</p></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="utils.js"></script>

  <script>
    protegerPagina();
    const estoqueRef = database.ref("estoque");
    const clientesRef = database.ref("clientes");
    const transacoesRef = database.ref("transacoes");
    const osRef = database.ref("ordens_servico"); // Nova refer√™ncia
    const configRef = database.ref('configuracoes');

    let produtosData = [], clientesData = {}, carrinho = [], osData = [];
    let html5QrcodeScanner = null;
    let saleMode = 'balcao'; // 'balcao' ou 'os'
    let selectedOsId = null;
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    auth.onAuthStateChanged(user => {
      if(user) {
        configRef.on('value', snapshot => {
            const config = snapshot.val() || {};
            if (config.darkMode) document.body.classList.add('dark-mode');
        });
      }
    });

    estoqueRef.on("value", snapshot => {
        const data = snapshot.val() || {};
        produtosData = Object.entries(data).map(([id, item]) => ({ id, ...item }));
        renderizarVitrine();
    });
    clientesRef.on("value", snapshot => { clientesData = snapshot.val() || {}; });
    
    // Carrega OS para busca
    osRef.on("value", snapshot => {
        const data = snapshot.val() || {};
        osData = Object.entries(data).map(([id, item]) => ({ id, ...item }));
        // Se estiver no modo OS, atualiza a lista
        if (saleMode === 'os') filtrarOS('');
    });

    function renderizarVitrine() {
        const grid = document.getElementById('produtosGrid');
        const termo = document.getElementById('searchProduto').value.toLowerCase();
        grid.innerHTML = '';
        const filtrados = produtosData.filter(p => (p.nomePeca || '').toLowerCase().includes(termo) || (p.codigoPeca || '').toLowerCase().includes(termo));
        const limiteExibicao = termo.length > 0 ? 100 : 30;
        
        filtrados.slice(0, limiteExibicao).forEach(produto => {
            const qtd = parseInt(produto.quantidade || 0);
            const card = document.createElement('div');
            card.className = 'produto-card';
            card.innerHTML = `
                <div class="produto-nome">${produto.nomePeca}</div>
                <div class="produto-info"><div class="produto-preco">${formatarMoeda(produto.valorUnitario)}</div><div class="produto-estoque ${qtd <= 0 ? 'estoque-baixo' : ''}">${qtd > 0 ? `Estoque: ${qtd}` : 'Sem Estoque'}</div></div>
                <div class="add-icon">+</div>
            `;
            if (qtd > 0) card.onclick = () => adicionarAoCarrinho(produto);
            else { card.style.opacity = '0.6'; card.style.cursor = 'not-allowed'; }
            grid.appendChild(card);
        });
        if(filtrados.length > limiteExibicao) {
            const aviso = document.createElement('div'); aviso.style.gridColumn = "1 / -1"; aviso.style.textAlign = "center"; aviso.style.padding = "20px"; aviso.style.color = "var(--text-secondary)"; aviso.innerHTML = "Use a busca para encontrar mais produtos..."; grid.appendChild(aviso);
        }
    }
    document.getElementById('searchProduto').addEventListener('input', renderizarVitrine);

    // --- L√ìGICA DE MODOS DE VENDA ---
    function setSaleMode(mode) {
        saleMode = mode;
        const btnBalcao = document.getElementById('modeBalcao');
        const btnOS = document.getElementById('modeOS');
        const divClient = document.getElementById('divClientSearch');
        const divOS = document.getElementById('divOSSearch');
        const divPagamento = document.getElementById('divPagamento');
        const btnFinalizar = document.getElementById('btnFinalizar');

        if(mode === 'balcao') {
            btnBalcao.classList.add('active'); btnOS.classList.remove('active');
            divClient.style.display = 'block'; divOS.style.display = 'none';
            divPagamento.style.display = 'block';
            btnFinalizar.innerHTML = "‚úÖ Finalizar Venda";
        } else {
            btnOS.classList.add('active'); btnBalcao.classList.remove('active');
            divClient.style.display = 'none'; divOS.style.display = 'block';
            divPagamento.style.display = 'none'; // N√£o cobra agora
            btnFinalizar.innerHTML = "üõ†Ô∏è Alocar na OS";
            filtrarOS(''); // Carrega as OS recentes
        }
        renderizarCarrinho();
    }

    // --- L√ìGICA DE BUSCA DE OS ---
    document.getElementById('osSearchInput').addEventListener('input', (e) => filtrarOS(e.target.value));
    document.getElementById('osSearchInput').addEventListener('focus', () => filtrarOS(document.getElementById('osSearchInput').value));

    function filtrarOS(termo) {
        const lista = document.getElementById('osListDropdown');
        lista.innerHTML = '';
        const termoLower = termo.toLowerCase();

        // Filtra apenas OS abertas (n√£o finalizadas/canceladas)
        let osAbertas = osData.filter(os => 
            ['orcamento', 'aguardando_pecas', 'em_servico', 'em_andamento'].includes(os.statusOS)
        );

        // Se tem termo, filtra pelo termo. Se n√£o, pega as √∫ltimas 5.
        if (termoLower.length > 0) {
            osAbertas = osAbertas.filter(os => 
                (os.clienteNome || '').toLowerCase().includes(termoLower) || 
                String(os.numeroOS).includes(termoLower)
            );
        } else {
            // Ordena por data (mais recente) e pega 5
            osAbertas.sort((a,b) => new Date(b.criadoEm || 0) - new Date(a.criadoEm || 0));
            osAbertas = osAbertas.slice(0, 5);
        }

        if(osAbertas.length === 0) {
            lista.innerHTML = '<div style="padding:12px; color:#666; text-align:center;">Nenhuma OS aberta encontrada</div>';
            return;
        }

        osAbertas.forEach(os => {
            const div = document.createElement('div');
            div.className = 'os-item-drop';
            div.innerHTML = `
                <div>
                    <strong>OS #${String(os.numeroOS).padStart(4,'0')}</strong> - ${os.clienteNome}<br>
                    <small style="color:#666;">${os.aparelho || ''}</small>
                </div>
                <span class="os-item-tag">${os.statusOS}</span>
            `;
            div.onclick = () => selecionarOS(os);
            lista.appendChild(div);
        });
    }

    function selecionarOS(os) {
        selectedOsId = os.id;
        document.getElementById('osInputContainer').classList.remove('show');
        document.getElementById('selectedOSDisplay').style.display = 'flex';
        document.getElementById('txtSelectedOS').textContent = `OS #${String(os.numeroOS).padStart(4,'0')} - ${os.clienteNome}`;
    }

    function limparSelecaoOS() {
        selectedOsId = null;
        document.getElementById('osInputContainer').classList.add('show');
        document.getElementById('selectedOSDisplay').style.display = 'none';
        filtrarOS('');
    }

    // --- FUN√á√ïES DE ABAS MOBILE ---
    function mudarAbaMobile(aba) {
        const tabVitrine = document.getElementById('tabVitrine');
        const tabCarrinho = document.getElementById('tabCarrinho');
        const footerCarrinho = document.getElementById('footerCarrinho');
        const btns = document.querySelectorAll('.mobile-tab');
        btns.forEach(b => b.classList.remove('active'));

        if (aba === 'vitrine') {
            tabVitrine.classList.add('active'); tabCarrinho.classList.remove('active');
            footerCarrinho.classList.remove('active'); btns[0].classList.add('active');
        } else {
            tabVitrine.classList.remove('active'); tabCarrinho.classList.add('active');
            footerCarrinho.classList.add('active'); btns[1].classList.add('active');
        }
    }

    // --- CARRINHO & SCANNER (MANTIDOS) ---
    function adicionarAoCarrinho(produto, fromScanner = false) {
        const itemExistente = carrinho.find(item => item.id === produto.id);
        if (itemExistente) {
            if (itemExistente.qtd < produto.quantidade) { itemExistente.qtd++; if(fromScanner) playBeep(); }
            else { alert("Limite de estoque atingido!"); return; }
        } else {
            carrinho.push({ id: produto.id, nome: produto.nomePeca, valor: parseFloat(produto.valorUnitario), qtd: 1, maxEstoque: produto.quantidade });
            if(fromScanner) playBeep();
        }
        renderizarCarrinho();
        if(fromScanner) pausarScannerComMensagem(`‚úÖ ${produto.nomePeca}<br>Adicionado!`);
        atualizarBadgeMobile();
    }

    function atualizarBadgeMobile() {
        const count = carrinho.reduce((acc, item) => acc + item.qtd, 0);
        const badge = document.getElementById('badgeCarrinho');
        badge.innerText = count; badge.style.display = count > 0 ? 'inline-block' : 'none';
    }

    function alterarQtd(index, delta) {
        const item = carrinho[index]; const novaQtd = item.qtd + delta;
        if (novaQtd > 0 && novaQtd <= item.maxEstoque) item.qtd = novaQtd;
        else if (novaQtd > item.maxEstoque) alert("Quantidade excede o estoque!");
        renderizarCarrinho(); atualizarBadgeMobile();
    }
    function removerItem(index) { carrinho.splice(index, 1); renderizarCarrinho(); atualizarBadgeMobile(); }
    
    function renderizarCarrinho() {
        const lista = document.getElementById('carrinhoLista'); lista.innerHTML = '';
        if (carrinho.length === 0) { lista.innerHTML = `<div style="text-align: center; color: var(--text-secondary); margin-top: 40px;"><p style="font-size: 3rem; margin-bottom: 10px;">üõí</p><p>Seu carrinho est√° vazio</p></div>`; atualizarTotais(); return; }
        carrinho.forEach((item, index) => {
            const div = document.createElement('div'); div.className = 'carrinho-item';
            div.innerHTML = `<div class="item-info"><div class="item-nome">${item.nome}</div><div class="item-preco">${formatarMoeda(item.valor)} un.</div></div><div class="item-qtd-control"><button class="btn-qtd" onclick="alterarQtd(${index}, -1)">-</button><span class="item-qtd">${item.qtd}</span><button class="btn-qtd" onclick="alterarQtd(${index}, 1)">+</button></div><div class="item-total">${formatarMoeda(item.valor * item.qtd)}</div><button class="btn-remove" onclick="removerItem(${index})">üóë</button>`;
            lista.appendChild(div);
        });
        atualizarTotais();
    }
    function atualizarTotais() {
        const subtotal = carrinho.reduce((acc, item) => acc + (item.valor * item.qtd), 0);
        const desconto = parseFloat(document.getElementById('inputDesconto').value) || 0;
        const total = Math.max(0, subtotal - desconto);
        document.getElementById('lblSubtotal').textContent = formatarMoeda(subtotal);
        document.getElementById('lblTotal').textContent = formatarMoeda(total);
        const btn = document.getElementById('btnFinalizar');
        btn.disabled = carrinho.length === 0;
        
        // Texto do bot√£o muda conforme o modo
        if (carrinho.length > 0) {
            btn.innerHTML = saleMode === 'balcao' 
                ? `‚úÖ Finalizar Venda (${formatarMoeda(total)})`
                : `üõ†Ô∏è Alocar na OS (${formatarMoeda(total)})`;
        } else {
            btn.innerHTML = saleMode === 'balcao' ? `‚úÖ Finalizar Venda` : `üõ†Ô∏è Alocar na OS`;
        }
    }
    document.getElementById('inputDesconto').addEventListener('input', atualizarTotais);

    function abrirScanner() {
        document.getElementById('scannerModal').classList.add('active');
        document.getElementById('scanSuccessOverlay').classList.remove('show');
        if (audioCtx.state === 'suspended') audioCtx.resume();
        if (html5QrcodeScanner) return;
        html5QrcodeScanner = new Html5Qrcode("reader");
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess).catch(err => { alert("Erro ao iniciar c√¢mera: " + err); fecharScanner(); });
    }
    function fecharScanner() {
        if (html5QrcodeScanner) { html5QrcodeScanner.stop().then(() => { html5QrcodeScanner.clear(); html5QrcodeScanner = null; }).catch(err => console.error(err)); }
        document.getElementById('scannerModal').classList.remove('active');
    }
    function onScanSuccess(decodedText, decodedResult) {
        const codigoLido = decodedText.trim();
        const produtoEncontrado = produtosData.find(p => p.id === codigoLido || (p.codigoPeca && p.codigoPeca.trim() === codigoLido));
        if (produtoEncontrado) adicionarAoCarrinho(produtoEncontrado, true);
        else { html5QrcodeScanner.pause(true); playErrorBeep(); if(confirm(`C√≥digo: ${codigoLido}\n\nProduto n√£o encontrado! Tentar novamente?`)) { html5QrcodeScanner.resume(); } else { fecharScanner(); } }
    }
    function pausarScannerComMensagem(mensagem) { if(html5QrcodeScanner) html5QrcodeScanner.pause(true); const overlay = document.getElementById('scanSuccessOverlay'); document.getElementById('scanMsg').innerHTML = mensagem; overlay.classList.add('show'); }
    function lerProximo() { const overlay = document.getElementById('scanSuccessOverlay'); overlay.classList.remove('show'); if(html5QrcodeScanner) html5QrcodeScanner.resume(); }
    function playBeep() { if (audioCtx.state === 'suspended') audioCtx.resume(); const oscillator = audioCtx.createOscillator(); const gainNode = audioCtx.createGain(); oscillator.connect(gainNode); gainNode.connect(audioCtx.destination); oscillator.type = 'square'; oscillator.frequency.value = 1500; gainNode.gain.value = 0.1; oscillator.start(); setTimeout(() => oscillator.stop(), 100); }
    function playErrorBeep() { if (audioCtx.state === 'suspended') audioCtx.resume(); const oscillator = audioCtx.createOscillator(); const gainNode = audioCtx.createGain(); oscillator.connect(gainNode); gainNode.connect(audioCtx.destination); oscillator.type = 'sawtooth'; oscillator.frequency.value = 200; gainNode.gain.value = 0.1; oscillator.start(); setTimeout(() => oscillator.stop(), 300); }

    // --- CLIENTE SEARCH ---
    const clienteInput = document.getElementById('clienteInput');
    const suggestionsBox = document.getElementById('clienteSuggestions');
    clienteInput.addEventListener('input', function() {
        const termo = this.value.toLowerCase();
        document.getElementById('clienteId').value = "";
        if (termo.length < 2) { suggestionsBox.classList.remove('show'); return; }
        const matches = Object.entries(clientesData).filter(([id, c]) => c.nome.toLowerCase().includes(termo)).slice(0, 5);
        if (matches.length > 0) {
            suggestionsBox.innerHTML = '';
            matches.forEach(([id, c]) => {
                const div = document.createElement('div'); div.className = 'suggestion-item';
                div.innerHTML = `<strong>${c.nome}</strong> <small>(${c.telefone})</small>`;
                div.onclick = () => { clienteInput.value = c.nome; document.getElementById('clienteId').value = id; suggestionsBox.classList.remove('show'); };
                suggestionsBox.appendChild(div);
            });
            suggestionsBox.classList.add('show');
        } else { suggestionsBox.classList.remove('show'); }
    });
    document.addEventListener('click', (e) => { if (!e.target.closest('.cliente-search')) suggestionsBox.classList.remove('show'); });

    // --- FINALIZA√á√ÉO UNIFICADA ---
    function imprimirComprovante(nomeCliente, formaPagamento, subtotal, desconto, totalFinal) {
        document.getElementById('cupomData').textContent = new Date().toLocaleString('pt-BR');
        document.getElementById('cupomCliente').textContent = nomeCliente;
        document.getElementById('cupomPagamento').textContent = formaPagamento;
        const tbody = document.getElementById('cupomItens'); tbody.innerHTML = '';
        carrinho.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${item.nome}</td><td class="text-right">${item.qtd}</td><td class="text-right">${formatarMoeda(item.valor * item.qtd)}</td>`;
            tbody.appendChild(tr);
        });
        document.getElementById('cupomSubtotal').textContent = formatarMoeda(subtotal);
        document.getElementById('cupomDesconto').textContent = formatarMoeda(desconto);
        document.getElementById('cupomTotal').textContent = formatarMoeda(totalFinal);
        window.print();
    }

    async function finalizarVenda() {
        if (carrinho.length === 0) return;
        const btn = document.getElementById('btnFinalizar'); btn.disabled = true; btn.textContent = "Processando...";
        
        const updates = {}; 
        const timestamp = new Date().toISOString(); 
        const dataHoje = timestamp.split('T')[0];
        
        try {
            // 1. Baixa no Estoque (Comum aos dois modos)
            let resumoItens = [];
            carrinho.forEach(item => {
                const produtoAtual = produtosData.find(p => p.id === item.id);
                if (produtoAtual) {
                    updates[`/estoque/${item.id}/quantidade`] = produtoAtual.quantidade - item.qtd;
                    updates[`/estoque/${item.id}/atualizadoEm`] = timestamp;
                    resumoItens.push(`${item.qtd}x ${item.nome}`);
                }
            });

            const subtotal = carrinho.reduce((acc, item) => acc + (item.valor * item.qtd), 0);
            const desconto = parseFloat(document.getElementById('inputDesconto').value) || 0;
            const totalFinal = Math.max(0, subtotal - desconto);

            if (saleMode === 'balcao') {
                // --- MODO BALC√ÉO: Gera Financeiro ---
                if (!confirm("Confirmar a venda balc√£o?")) { btn.disabled = false; btn.textContent = "‚úÖ Finalizar Venda"; return; }
                
                const nomeCliente = document.getElementById('clienteInput').value || "Cliente Balc√£o";
                const formaPagamento = document.getElementById('formaPagamento').value;
                const novaTransacaoKey = transacoesRef.push().key;
                
                updates[`/transacoes/${novaTransacaoKey}`] = {
                    tipo: 'entrada', descricao: `Venda PDV - ${nomeCliente}`, observacoes: `Itens: ${resumoItens.join(', ')}`, categoria: 'Venda de Pe√ßas',
                    valor: totalFinal, dataTransacao: dataHoje, statusTransacao: 'pago', formaPagamento: formaPagamento, criadoPor: auth.currentUser.email, criadoEm: timestamp, origem: 'pdv'
                };
                
                await database.ref().update(updates);
                if(confirm("‚úÖ Venda realizada!\n\nDeseja imprimir o comprovante?")) imprimirComprovante(nomeCliente, formaPagamento, subtotal, desconto, totalFinal);
                
            } else {
                // --- MODO OS: Atualiza Ordem de Servi√ßo ---
                if (!selectedOsId) { alert("Selecione uma OS para vincular!"); btn.disabled = false; btn.textContent = "üõ†Ô∏è Alocar na OS"; return; }
                const osAlvo = osData.find(os => os.id === selectedOsId);
                if (!osAlvo) { alert("OS n√£o encontrada."); btn.disabled = false; btn.textContent = "üõ†Ô∏è Alocar na OS"; return; }
                
                if (!confirm(`Confirmar aloca√ß√£o de pe√ßas na OS #${osAlvo.numeroOS}?`)) { btn.disabled = false; btn.textContent = "üõ†Ô∏è Alocar na OS"; return; }

                // Prepara novas pe√ßas para o formato da OS
                const novasPecas = carrinho.map(c => ({
                    pecaId: c.id, nome: c.nome, quantidade: c.qtd, valorUnitario: c.valor
                }));
                
                // Mescla com pe√ßas existentes
                const pecasExistentes = osAlvo.pecas || [];
                const pecasAtualizadas = [...pecasExistentes, ...novasPecas];
                
                // Recalcula totais da OS
                const totalPecasOS = pecasAtualizadas.reduce((sum, p) => sum + (p.quantidade * p.valorUnitario), 0);
                const maoObra = parseFloat(osAlvo.valorMaoObra) || 0;
                const descontoOS = parseFloat(osAlvo.desconto) || 0;
                // Nota: O desconto do PDV √© aplicado como desconto extra na OS? 
                // Simplifica√ß√£o: Vamos somar o desconto do PDV ao desconto da OS
                const novoDescontoTotal = descontoOS + desconto;
                const novoTotalOS = maoObra + totalPecasOS - novoDescontoTotal;

                updates[`/ordens_servico/${selectedOsId}/pecas`] = pecasAtualizadas;
                updates[`/ordens_servico/${selectedOsId}/valorPecas`] = totalPecasOS;
                updates[`/ordens_servico/${selectedOsId}/desconto`] = novoDescontoTotal;
                updates[`/ordens_servico/${selectedOsId}/valorTotalFinal`] = novoTotalOS;
                updates[`/ordens_servico/${selectedOsId}/atualizadoEm`] = timestamp;

                await database.ref().update(updates);
                alert(`‚úÖ Pe√ßas alocadas na OS #${osAlvo.numeroOS} com sucesso!`);
            }

            // Limpeza P√≥s-Venda
            carrinho = []; 
            document.getElementById('clienteInput').value = ""; document.getElementById('clienteId').value = ""; 
            document.getElementById('inputDesconto').value = ""; 
            limparSelecaoOS();
            renderizarCarrinho(); atualizarBadgeMobile();
            
        } catch (error) { 
            console.error(error); alert("Erro: " + error.message); 
        } finally { 
            btn.disabled = false; 
            btn.innerHTML = saleMode === 'balcao' ? `‚úÖ Finalizar Venda` : `üõ†Ô∏è Alocar na OS`;
        }
    }
    
    function formatarMoeda(valor) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor || 0); }
  </script>
</body>
</html>
