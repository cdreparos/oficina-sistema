<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDV - Venda R√°pida - SIGO</title>
  <style>
    :root {
      --sidebar-bg: #1e293b;
      --main-bg: #e2e8f0;
      --card-bg: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --accent-purple: #8b5cf6; /* Cor tem√°tica do PDV */
      --accent-green: #10b981;
      --accent-red: #ef4444;
      --border-color: #e2e8f0;
    }

    body.dark-mode {
        --main-bg: #0f172a;
        --card-bg: #1e293b;
        --text-primary: #f1f5f9;
        --text-secondary: #94a3b8;
        --border-color: #334155;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: var(--main-bg); color: var(--text-primary); height: 100vh; overflow: hidden; }
    
    /* Layout principal dividido */
    .pdv-container { display: grid; grid-template-columns: 240px 1fr 400px; height: 100vh; }
    
    /* Sidebar (Simplificada para manter contexto) */
    .sidebar { background: var(--sidebar-bg); color: #fff; display: flex; flex-direction: column; padding: 24px 16px; height: 100%; z-index: 100; }
    .sidebar-header { display: flex; align-items: center; gap: 12px; margin-bottom: 30px; }
    .sidebar-logo { width: 40px; height: 40px; background: var(--accent-purple); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; }
    .nav-list { list-style: none; }
    .nav-list a { color: #cbd5e1; text-decoration: none; display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 8px; font-weight: 500; margin-bottom: 4px; transition: all 0.2s; }
    .nav-list a:hover { background: rgba(255,255,255,0.1); color: #fff; }
    .back-btn { margin-top: auto; background: rgba(255,255,255,0.1); border: none; color: white; padding: 12px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 1rem; width: 100%; }
    .back-btn:hover { background: var(--accent-red); }

    /* √Årea Central - Vitrine */
    .vitrine-area { padding: 24px; display: flex; flex-direction: column; height: 100%; overflow: hidden; }
    .search-bar { margin-bottom: 20px; position: relative; }
    .search-bar input { width: 100%; padding: 16px 20px 16px 50px; border: 2px solid var(--border-color); border-radius: 12px; font-size: 1.1rem; background: var(--card-bg); color: var(--text-primary); transition: all 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
    .search-bar input:focus { outline: none; border-color: var(--accent-purple); box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1); }
    .search-icon { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); font-size: 1.2rem; color: var(--text-secondary); }
    
    .produtos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; overflow-y: auto; padding-right: 8px; flex-grow: 1; }
    .produto-card { background: var(--card-bg); border-radius: 12px; padding: 16px; border: 1px solid var(--border-color); cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; justify-content: space-between; position: relative; overflow: hidden; height: 160px; padding: 16px; }
    .produto-card:hover { transform: translateY(-4px); border-color: var(--accent-purple); box-shadow: 0 10px 15px rgba(0,0,0,0.05); }
    .produto-card:active { transform: scale(0.98); }
    .produto-nome { font-weight: 600; font-size: 0.95rem; margin-bottom: 8px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
    .produto-info { margin-top: auto; }
    .produto-preco { font-size: 1.2rem; font-weight: 700; color: var(--accent-purple); }
    .produto-estoque { font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px; }
    .add-icon { position: absolute; bottom: 12px; right: 12px; background: var(--accent-purple); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; opacity: 0; transition: all 0.2s; transform: scale(0.5); }
    .produto-card:hover .add-icon { opacity: 1; transform: scale(1); }
    .estoque-baixo { color: var(--accent-red); font-weight: bold; }

    /* √Årea Direita - Carrinho/Caixa */
    .carrinho-area { background: var(--card-bg); border-left: 1px solid var(--border-color); display: flex; flex-direction: column; height: 100%; box-shadow: -4px 0 20px rgba(0,0,0,0.05); z-index: 50; }
    .carrinho-header { padding: 24px; border-bottom: 1px solid var(--border-color); background: var(--main-bg); }
    
    /* Busca de Cliente Estilizada */
    .cliente-search { position: relative; margin-bottom: 10px; }
    .cliente-search input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-primary); font-size: 0.95rem; }
    .cliente-suggestions { position: absolute; top: 100%; left: 0; right: 0; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none; }
    .cliente-suggestions.show { display: block; }
    .suggestion-item { padding: 10px 14px; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: background 0.2s; }
    .suggestion-item:hover { background: var(--main-bg); }
    
    .carrinho-lista { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
    .carrinho-item { display: flex; justify-content: space-between; align-items: center; background: var(--main-bg); padding: 12px; border-radius: 10px; animation: slideIn 0.3s ease; }
    @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
    .item-info { flex-grow: 1; }
    .item-nome { font-weight: 600; font-size: 0.9rem; margin-bottom: 4px; }
    .item-preco { font-size: 0.85rem; color: var(--text-secondary); }
    .item-qtd-control { display: flex; align-items: center; gap: 10px; margin: 0 16px; background: var(--card-bg); padding: 4px; border-radius: 6px; }
    .btn-qtd { width: 24px; height: 24px; border: none; background: transparent; color: var(--text-primary); cursor: pointer; font-weight: bold; border-radius: 4px; }
    .btn-qtd:hover { background: var(--border-color); }
    .item-qtd { font-weight: 600; font-size: 0.9rem; width: 20px; text-align: center; }
    .item-total { font-weight: 700; color: var(--text-primary); font-size: 0.95rem; min-width: 70px; text-align: right; }
    .btn-remove { color: var(--text-secondary); background: none; border: none; cursor: pointer; padding: 4px; margin-left: 8px; transition: color 0.2s; }
    .btn-remove:hover { color: var(--accent-red); }

    .carrinho-footer { padding: 24px; border-top: 1px solid var(--border-color); background: var(--card-bg); }
    .resumo-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-secondary); }
    .resumo-row.total { font-size: 1.5rem; font-weight: 800; color: var(--text-primary); margin-top: 16px; margin-bottom: 24px; align-items: center; }
    .input-desconto { width: 80px; padding: 4px 8px; border: 1px solid var(--border-color); border-radius: 4px; text-align: right; background: var(--main-bg); color: var(--text-primary); }
    
    .pagamento-select { width: 100%; padding: 12px; border-radius: 8px; border: 2px solid var(--border-color); background: var(--main-bg); color: var(--text-primary); font-size: 1rem; margin-bottom: 16px; font-weight: 500; cursor: pointer; }
    .btn-finalizar { width: 100%; padding: 16px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3); display: flex; justify-content: center; align-items: center; gap: 10px; }
    .btn-finalizar:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(124, 58, 237, 0.4); }
    .btn-finalizar:disabled { background: var(--text-secondary); cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.5; }

    /* Responsividade */
    .mobile-menu-btn { display: none; }
    @media (max-width: 1100px) { .pdv-container { grid-template-columns: 80px 1fr 350px; } .sidebar-header h1 { display: none; } .nav-list a span:not(.nav-icon) { display: none; } }
    @media (max-width: 768px) { 
        .pdv-container { grid-template-columns: 1fr; grid-template-rows: auto 1fr auto; display: block; overflow-y: auto; }
        .sidebar { display: none; }
        .carrinho-area { height: auto; border-left: none; border-top: 1px solid var(--border-color); padding-bottom: 20px; }
        .vitrine-area { height: auto; min-height: 500px; }
    }
  </style>
</head>
<body>

  <div class="pdv-container">
    <nav class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">PDV</div>
        <h1 style="font-size: 1.2rem;">Venda R√°pida</h1>
      </div>
      <div style="flex-grow: 1;"></div>
      <button class="back-btn" onclick="window.location.href='painel.html'">
        <span>‚¨Ö</span> Voltar ao Painel
      </button>
    </nav>

    <main class="vitrine-area">
      <div class="search-bar">
        <span class="search-icon">üîç</span>
        <input type="text" id="searchProduto" placeholder="Buscar pe√ßa por nome ou c√≥digo..." autofocus>
      </div>
      <div class="produtos-grid" id="produtosGrid">
        </div>
    </main>

    <aside class="carrinho-area">
      <div class="carrinho-header">
        <h3 style="margin-bottom: 12px; color: var(--text-primary);">üë§ Cliente</h3>
        <div class="cliente-search">
            <input type="text" id="clienteInput" placeholder="Nome do Cliente (Opcional)">
            <input type="hidden" id="clienteId">
            <div class="cliente-suggestions" id="clienteSuggestions"></div>
        </div>
      </div>

      <div class="carrinho-lista" id="carrinhoLista">
        <div style="text-align: center; color: var(--text-secondary); margin-top: 40px;">
            <p style="font-size: 3rem; margin-bottom: 10px;">üõí</p>
            <p>Seu carrinho est√° vazio</p>
        </div>
      </div>

      <div class="carrinho-footer">
        <div class="resumo-row">
            <span>Subtotal</span>
            <span id="lblSubtotal">R$ 0,00</span>
        </div>
        <div class="resumo-row" style="align-items: center;">
            <span>Desconto</span>
            <input type="number" id="inputDesconto" class="input-desconto" placeholder="0,00" min="0" step="0.01">
        </div>
        <div class="resumo-row total">
            <span>TOTAL</span>
            <span id="lblTotal" style="color: var(--accent-purple);">R$ 0,00</span>
        </div>

        <select class="pagamento-select" id="formaPagamento">
            <option value="Dinheiro">üíµ Dinheiro</option>
            <option value="PIX">üí† PIX</option>
            <option value="Cart√£o de D√©bito">üí≥ Cart√£o de D√©bito</option>
            <option value="Cart√£o de Cr√©dito">üí≥ Cart√£o de Cr√©dito</option>
        </select>

        <button class="btn-finalizar" id="btnFinalizar" onclick="finalizarVenda()">
            ‚úÖ Finalizar Venda
        </button>
      </div>
    </aside>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="utils.js"></script>

  <script>
    // Inicializa√ß√£o
    protegerPagina();
    const estoqueRef = database.ref("estoque");
    const clientesRef = database.ref("clientes");
    const transacoesRef = database.ref("transacoes");
    const configRef = database.ref('configuracoes');

    let produtosData = [];
    let clientesData = {};
    let carrinho = [];

    // Carregar Configura√ß√µes (Dark Mode)
    auth.onAuthStateChanged(user => {
      if(user) {
        configRef.on('value', snapshot => {
            const config = snapshot.val() || {};
            if (config.darkMode) document.body.classList.add('dark-mode');
        });
      }
    });

    // 1. CARREGAR PRODUTOS (ESTOQUE)
    estoqueRef.on("value", snapshot => {
        const data = snapshot.val() || {};
        produtosData = Object.entries(data).map(([id, item]) => ({ id, ...item }));
        renderizarVitrine();
    });

    // 2. CARREGAR CLIENTES (PARA BUSCA)
    clientesRef.on("value", snapshot => {
        clientesData = snapshot.val() || {};
    });

    // Renderizar Vitrine
    function renderizarVitrine() {
        const grid = document.getElementById('produtosGrid');
        const termo = document.getElementById('searchProduto').value.toLowerCase();
        grid.innerHTML = '';

        const filtrados = produtosData.filter(p => {
            const nome = (p.nomePeca || '').toLowerCase();
            const codigo = (p.codigoPeca || '').toLowerCase();
            return nome.includes(termo) || codigo.includes(termo);
        });

        filtrados.forEach(produto => {
            const qtd = parseInt(produto.quantidade || 0);
            const card = document.createElement('div');
            card.className = 'produto-card';
            card.innerHTML = `
                <div class="produto-nome">${produto.nomePeca}</div>
                <div class="produto-info">
                    <div class="produto-preco">${formatarMoeda(produto.valorUnitario)}</div>
                    <div class="produto-estoque ${qtd <= 0 ? 'estoque-baixo' : ''}">
                        ${qtd > 0 ? `Estoque: ${qtd}` : 'Sem Estoque'}
                    </div>
                </div>
                <div class="add-icon">+</div>
            `;
            // S√≥ permite adicionar se tiver estoque
            if (qtd > 0) {
                card.onclick = () => adicionarAoCarrinho(produto);
            } else {
                card.style.opacity = '0.6';
                card.style.cursor = 'not-allowed';
            }
            grid.appendChild(card);
        });
    }

    document.getElementById('searchProduto').addEventListener('input', renderizarVitrine);

    // 3. L√ìGICA DO CARRINHO
    function adicionarAoCarrinho(produto) {
        const itemExistente = carrinho.find(item => item.id === produto.id);
        
        if (itemExistente) {
            if (itemExistente.qtd < produto.quantidade) {
                itemExistente.qtd++;
            } else {
                alert("Limite de estoque atingido para este item!");
                return;
            }
        } else {
            carrinho.push({
                id: produto.id,
                nome: produto.nomePeca,
                valor: parseFloat(produto.valorUnitario),
                qtd: 1,
                maxEstoque: produto.quantidade
            });
        }
        renderizarCarrinho();
    }

    function alterarQtd(index, delta) {
        const item = carrinho[index];
        const novaQtd = item.qtd + delta;
        
        if (novaQtd > 0 && novaQtd <= item.maxEstoque) {
            item.qtd = novaQtd;
        } else if (novaQtd > item.maxEstoque) {
            alert("Quantidade excede o estoque atual!");
        }
        renderizarCarrinho();
    }

    function removerItem(index) {
        carrinho.splice(index, 1);
        renderizarCarrinho();
    }

    function renderizarCarrinho() {
        const lista = document.getElementById('carrinhoLista');
        lista.innerHTML = '';

        if (carrinho.length === 0) {
            lista.innerHTML = `
                <div style="text-align: center; color: var(--text-secondary); margin-top: 40px;">
                    <p style="font-size: 3rem; margin-bottom: 10px;">üõí</p>
                    <p>Seu carrinho est√° vazio</p>
                </div>`;
            atualizarTotais();
            return;
        }

        carrinho.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'carrinho-item';
            div.innerHTML = `
                <div class="item-info">
                    <div class="item-nome">${item.nome}</div>
                    <div class="item-preco">${formatarMoeda(item.valor)} un.</div>
                </div>
                <div class="item-qtd-control">
                    <button class="btn-qtd" onclick="alterarQtd(${index}, -1)">-</button>
                    <span class="item-qtd">${item.qtd}</span>
                    <button class="btn-qtd" onclick="alterarQtd(${index}, 1)">+</button>
                </div>
                <div class="item-total">${formatarMoeda(item.valor * item.qtd)}</div>
                <button class="btn-remove" onclick="removerItem(${index})">üóë</button>
            `;
            lista.appendChild(div);
        });
        atualizarTotais();
    }

    function atualizarTotais() {
        const subtotal = carrinho.reduce((acc, item) => acc + (item.valor * item.qtd), 0);
        const desconto = parseFloat(document.getElementById('inputDesconto').value) || 0;
        const total = Math.max(0, subtotal - desconto);

        document.getElementById('lblSubtotal').textContent = formatarMoeda(subtotal);
        document.getElementById('lblTotal').textContent = formatarMoeda(total);
        
        // Habilitar/Desabilitar bot√£o finalizar
        const btn = document.getElementById('btnFinalizar');
        btn.disabled = carrinho.length === 0;
        if(carrinho.length > 0) {
            btn.innerHTML = `‚úÖ Finalizar Venda (${formatarMoeda(total)})`;
        } else {
            btn.innerHTML = `‚úÖ Finalizar Venda`;
        }
    }

    document.getElementById('inputDesconto').addEventListener('input', atualizarTotais);

    // 4. BUSCA DE CLIENTES (AUTOCOMPLETE)
    const clienteInput = document.getElementById('clienteInput');
    const suggestionsBox = document.getElementById('clienteSuggestions');

    clienteInput.addEventListener('input', function() {
        const termo = this.value.toLowerCase();
        // Se digitar algo novo, limpa o ID para indicar cliente avulso/novo nome
        document.getElementById('clienteId').value = "";
        
        if (termo.length < 2) {
            suggestionsBox.classList.remove('show');
            return;
        }

        const matches = Object.entries(clientesData)
            .filter(([id, c]) => c.nome.toLowerCase().includes(termo))
            .slice(0, 5); // Max 5 sugest√µes

        if (matches.length > 0) {
            suggestionsBox.innerHTML = '';
            matches.forEach(([id, c]) => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.innerHTML = `<strong>${c.nome}</strong> <small>(${c.telefone})</small>`;
                div.onclick = () => selecionarCliente(id, c.nome);
                suggestionsBox.appendChild(div);
            });
            suggestionsBox.classList.add('show');
        } else {
            suggestionsBox.classList.remove('show');
        }
    });

    function selecionarCliente(id, nome) {
        clienteInput.value = nome;
        document.getElementById('clienteId').value = id;
        suggestionsBox.classList.remove('show');
    }

    // Fechar sugest√µes ao clicar fora
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.cliente-search')) {
            suggestionsBox.classList.remove('show');
        }
    });

    // 5. FINALIZAR VENDA (BAIXA ESTOQUE + FINANCEIRO)
    async function finalizarVenda() {
        if (!confirm("Confirmar a venda?")) return;

        const btn = document.getElementById('btnFinalizar');
        btn.disabled = true;
        btn.textContent = "Processando...";

        try {
            const updates = {};
            const timestamp = new Date().toISOString();
            const dataHoje = timestamp.split('T')[0];
            const nomeCliente = document.getElementById('clienteInput').value || "Cliente Balc√£o";
            const formaPagamento = document.getElementById('formaPagamento').value;
            
            // C√°lculos Finais
            const subtotal = carrinho.reduce((acc, item) => acc + (item.valor * item.qtd), 0);
            const desconto = parseFloat(document.getElementById('inputDesconto').value) || 0;
            const totalFinal = Math.max(0, subtotal - desconto);

            // 1. Preparar atualiza√ß√£o de Estoque
            let resumoItens = [];
            
            carrinho.forEach(item => {
                // Busca o item atualizado no 'produtosData' para garantir consist√™ncia
                const produtoAtual = produtosData.find(p => p.id === item.id);
                if (produtoAtual) {
                    const novaQtd = produtoAtual.quantidade - item.qtd;
                    // Caminho para atualizar no Firebase
                    updates[`/estoque/${item.id}/quantidade`] = novaQtd;
                    updates[`/estoque/${item.id}/atualizadoEm`] = timestamp;
                    resumoItens.push(`${item.qtd}x ${item.nome}`);
                }
            });

            // 2. Criar Transa√ß√£o Financeira
            const novaTransacaoKey = transacoesRef.push().key;
            const transacao = {
                tipo: 'entrada',
                descricao: `Venda PDV - ${nomeCliente}`,
                observacoes: `Itens: ${resumoItens.join(', ')}`,
                categoria: 'Venda de Pe√ßas', // Categoria Padr√£o
                valor: totalFinal,
                dataTransacao: dataHoje,
                statusTransacao: 'pago',
                formaPagamento: formaPagamento,
                criadoPor: auth.currentUser.email,
                criadoEm: timestamp,
                origem: 'pdv'
            };
            updates[`/transacoes/${novaTransacaoKey}`] = transacao;

            // 3. Enviar tudo de uma vez (Atomic Update)
            await database.ref().update(updates);

            // 4. Sucesso
            alert("‚úÖ Venda realizada com sucesso!");
            
            // Resetar Tela
            carrinho = [];
            document.getElementById('clienteInput').value = "";
            document.getElementById('clienteId').value = "";
            document.getElementById('inputDesconto').value = "";
            renderizarCarrinho();

        } catch (error) {
            console.error(error);
            alert("Erro ao processar venda: " + error.message);
        } finally {
            btn.disabled = false;
            renderizarCarrinho(); // Restaura o texto do bot√£o
        }
    }

    function formatarMoeda(valor) {
      return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor || 0);
    }
  </script>
</body>
</html>
