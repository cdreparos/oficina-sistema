<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ordens de Servi√ßo - SIGO</title>
    
    <style>
      :root {
          --sidebar-bg: #1e293b; --sidebar-bg-hover: #334155; --main-bg: #e2e8f0;
          --card-bg: #ffffff; --text-primary: #1e293b; --text-secondary: #64748b;
          --accent-blue: #3b82f6; --accent-red: #ef4444; --border-color: #e2e8f0;
          --accent-green: #10b981; --accent-yellow: #f59e0b; --accent-purple: #8b5cf6;
      }
      body.dark-mode {
          --main-bg: #0f172a; --card-bg: #1e293b; --text-primary: #f1f5f9;
          --text-secondary: #94a3b8; --border-color: #334155;
      }
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font-family: 'Inter', sans-serif; background: var(--main-bg); color: var(--text-primary); }
      .dashboard-container { display: grid; grid-template-columns: 240px 1fr; min-height: 100vh; }
      .sidebar { background: var(--sidebar-bg); color: #fff; display: flex; flex-direction: column; padding: 24px 16px; position: fixed; left: 0; top: 0; height: 100%; width: 240px; z-index: 100; transition: transform 0.3s ease-in-out; }
      .sidebar-header { display: flex; align-items: center; gap: 12px; padding-bottom: 24px; margin-bottom: 16px; border-bottom: 1px solid var(--sidebar-bg-hover); }
      .sidebar-logo { width: 40px; height: 40px; background: var(--accent-blue); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; }
      .sidebar-header h1 { font-size: 1.1rem; font-weight: 600; }
      .nav-list { list-style: none; flex-grow: 1; }
      .nav-list a { color: #cbd5e1; text-decoration: none; display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 8px; font-weight: 500; transition: all 0.2s ease-in-out; margin-bottom: 4px; }
      .nav-list a:hover { background: var(--sidebar-bg-hover); color: #fff; }
      .nav-list a.active { background: var(--accent-blue); color: #fff; }
      .nav-icon { font-size: 1.2rem; }
      .sidebar-footer { border-top: 1px solid var(--sidebar-bg-hover); padding-top: 16px; }
      .logout-btn { width: 100%; background: none; border: none; color: #cbd5e1; display: flex; align-items: center; gap: 12px; padding: 12px 16px; font-size: 1rem; cursor: pointer; text-align: left; font-family: inherit; border-radius: 8px; transition: all 0.2s ease-in-out; }
      .logout-btn:hover { background: var(--accent-red); color: #fff; }

      .main-content { grid-column: 2 / 3; padding: 32px; }
      .main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
      .main-header h1 { font-size: 1.8rem; font-weight: 700; color: var(--text-primary); }
      
      .actions-bar { background: var(--card-bg); padding: 20px 30px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; gap: 20px; flex-wrap: wrap; }
      .search-box { flex: 1; min-width: 300px; position: relative; }
      .search-box input { width: 100%; padding: 14px 20px 14px 50px; border: 2px solid var(--border-color); border-radius: 10px; font-size: 0.95rem; background-color: var(--main-bg); color: var(--text-primary); }
      .search-box::before { content: 'üîç'; position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); }
      .btn-primary { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; padding: 14px 28px; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(59,130,246,0.3); display: flex; align-items: center; gap: 8px; }
      .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(59,130,246,0.4); }

      .tabs-container { display: flex; gap: 4px; margin-bottom: 24px; overflow-x: auto; padding-bottom: 8px;}
      .tab { padding: 10px 20px; border: none; background: var(--card-bg); border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; color: var(--text-secondary); white-space: nowrap; }
      .tab.active { background: var(--accent-blue); color: white; }

      /* --- ESTRUTURA VISUAL: TABELA (Desktop) E CARDS (Mobile) --- */
      .os-table-container { display: none; } /* Escondido por padr√£o em telas pequenas */
      .os-cards-grid { display: grid; gap: 16px; } /* Vis√≠vel por padr√£o em telas pequenas */

      /* ESTILOS DA TABELA (Desktop) */
      .os-table-container { background: var(--card-bg); border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); overflow-x: auto; }
      .os-table { width: 100%; border-collapse: collapse; }
      .os-table th, .os-table td { padding: 16px 20px; text-align: left; border-bottom: 1px solid var(--border-color); }
      .os-table th { font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; }
      .subtext { font-size: 0.8rem; color: var(--text-secondary); margin-top: 2px; }
      .actions-cell { text-align: right; white-space: nowrap; }
      
      /* ESTILOS DOS CARDS (Mobile) */
      .os-card { background: var(--card-bg); border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
      .os-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
      .os-card-header .info strong { font-size: 1.1rem; }
      .os-card-body { font-size: 0.9rem; color: var(--text-secondary); }
      .os-card-body .detail { margin-bottom: 8px; }
      .os-card-footer { border-top: 1px solid var(--border-color); padding-top: 12px; margin-top: 16px; display: flex; justify-content: space-between; align-items: center; }
      .os-card-valor { font-weight: 700; font-size: 1.2rem; color: var(--accent-blue); }
      .os-card-actions { display: flex; gap: 8px; }
      
      /* Componentes Comuns */
      .status-badge { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
      .status-orcamento { background: #e0e7ff; color: #3730a3; } .status-aguardando_pecas { background: #fef3c7; color: #92400e; }
      .status-em_servico { background: #dbeafe; color: #1e40af; } .status-concluido { background: #d1fae5; color: #065f46; }
      .status-entregue { background: var(--sidebar-bg); color: #fff; } .status-cancelado { background: #fee2e2; color: #991b1b; }
      .dias-badge { background: var(--main-bg); color: var(--text-secondary); padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 600; }
      .prazo-badge { padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 600; }
      .prazo-urgente { background: #fef3c7; color: #92400e; } .prazo-atrasado { background: #fee2e2; color: #991b1b; }
      .btn-action { padding: 8px 16px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 0.8rem; }
      .btn-edit { background: #dbeafe; color: #1e40af; } .btn-edit:hover { background: #3b82f6; color: white; }
      .btn-reabrir { background: #fef3c7; color: #92400e; } .btn-reabrir:hover { background: #f59e0b; color: white; }
      
      /* Estilos do Modal (sem altera√ß√µes significativas) */
      .modal { display: none; position: fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); z-index:1000; padding:20px; }
      .modal.active { display: flex; align-items: flex-start; justify-content: center; overflow-y: auto; }
      .modal-content { background: var(--card-bg); border-radius: 20px; padding: 24px 32px; max-width: 800px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); margin-top: 5vh; margin-bottom: 5vh; }
      .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color); }
      .form-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; }
      .form-section-title { font-size: 0.9rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 20px; letter-spacing: 0.5px; }
      .form-group { margin-bottom: 16px; }
      .form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
      .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 10px; font-size: 0.95rem; background-color: var(--main-bg); color: var(--text-primary); }
      .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
      .pecas-list { max-height: 200px; overflow-y: auto; margin-bottom: 12px; border: 2px solid var(--border-color); border-radius: 10px; padding: 8px;}
      .peca-item { display: flex; align-items: center; gap: 8px; background: var(--main-bg); padding: 8px; border-radius: 8px; margin-bottom: 8px; }
      .total-section { background: var(--main-bg); padding: 16px; border-radius: 12px; }
      .total-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
      #valorTotalFinal { font-size: 1.5rem; font-weight: 800; color: var(--accent-blue); }
      .btn-link { background: none; border: none; color: var(--accent-blue); font-weight: 600; cursor: pointer; font-size: 0.85rem; }
      .btn-delete-peca { background: #fee2e2; color: #b91c1c; border-radius: 50%; width: 24px; height: 24px; border: none; cursor: pointer; }
      .btn-submit { padding: 14px; background: var(--accent-blue); color: white; border:none; border-radius: 10px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 16px; font-size: 1rem;}
      .suggestions { position: absolute; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 10px; z-index: 1001; max-height: 150px; overflow-y: auto; width: calc(100% - 32px); }
      .suggestion-item { padding: 10px; cursor: pointer; } .suggestion-item:hover { background: var(--main-bg); }
      
      .mobile-menu-btn { display: none; background: none; border: none; font-size: 1.8rem; cursor: pointer; color: var(--text-primary); }
      .overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:99; }

      /* --- L√ìGICA DE RESPONSIVIDADE --- */
      /* DESKTOP (992px em diante) */
      @media (min-width: 992px) {
        .os-cards-grid { display: none; } /* Esconde os cards */
        .os-table-container { display: block; } /* Mostra a tabela */
      }
      
      /* MOBILE (At√© 991px) */
      @media (max-width: 991px) {
        .dashboard-container { grid-template-columns: 1fr; }
        .sidebar { transform: translateX(-100%); }
        .sidebar.is-open { transform: translateX(0); }
        .main-content { grid-column: 1 / 2; padding: 16px; }
        .mobile-menu-btn { display: block; }
        .actions-bar { flex-direction: column; align-items: stretch; }
        .form-grid, .form-row { grid-template-columns: 1fr; }
      }
    </style>
</head>
<body>
  <div class="dashboard-container">
    <nav class="sidebar" id="sidebar">
      <div>
        <div class="sidebar-header"><div class="sidebar-logo">S</div><h1>SIGO Casa dos Reparos</h1></div>
        <ul class="nav-list">
            <li><a href="painel.html"><span class="nav-icon">üè†</span> Painel</a></li>
            <li><a href="ordens-servico.html" class="active"><span class="nav-icon">üõ†Ô∏è</span> Ordens de Servi√ßo</a></li>
            <li><a href="clientes.html"><span class="nav-icon">üë•</span> Clientes</a></li>
            <li><a href="agendamentos.html"><span class="nav-icon">üìÖ</span> Agenda</a></li>
            <li><a href="estoque.html"><span class="nav-icon">üì¶</span> Estoque</a></li>
            <li><a href="contas_financeiro.html"><span class="nav-icon">üí∞</span> Financeiro</a></li>
            <li><a href="anotacoes.html"><span class="nav-icon">üìù</span> Anota√ß√µes</a></li>
            <li><a href="pecas.html"><span class="nav-icon">üî©</span> Pe√ßas para Pedir</a></li>
            <li><a href="impressao.html"><span class="nav-icon">üñ®Ô∏è</span> Impress√£o</a></li>
            <li><a href="configuracoes.html"><span class="nav-icon">‚öôÔ∏è</span> Configura√ß√µes</a></li>
        </ul>
      </div>
      <div class="sidebar-footer">
        <button class="logout-btn" onclick="logout()">
          <span class="nav-icon">üö™</span> Sair do Sistema
        </button>
      </div>
    </nav>
    <div class="overlay" id="overlay"></div>

    <main class="main-content">
      <header class="main-header">
        <h1>Ordens de Servi√ßo</h1>
        <button class="mobile-menu-btn" id="mobileMenuBtn">‚ò∞</button>
      </header>
      
      <div class="actions-bar">
        <div class="search-box"><input type="text" id="searchInput" placeholder="Buscar por n¬∫ da OS, cliente ou aparelho..."></div>
        <button class="btn-primary" id="btnNovaOS"><span>‚ûï</span> Nova Ordem de Servi√ßo</button>
      </div>

      <div class="tabs-container" id="tabsOS">
        <button class="tab active" data-status="em_aberto">Em Aberto</button>
        <button class="tab" data-status="todos">Todas</button>
        <button class="tab" data-status="orcamento">Or√ßamento</button>
        <button class="tab" data-status="aguardando_pecas">Aguardando Pe√ßas</button>
        <button class="tab" data-status="em_servico">Em Servi√ßo</button>
        <button class="tab" data-status="concluido">Conclu√≠do</button>
        <button class="tab" data-status="entregue">Entregue</button>
        <button class="tab" data-status="cancelado">Cancelado</button>
      </div>

      <div class="os-table-container">
        <table class="os-table">
          <thead><tr><th>Status</th><th>N¬∫ OS</th><th>Cliente</th><th>Aparelho</th><th>Entrada</th><th>Valor Total</th><th></th></tr></thead>
          <tbody id="osTableBody"></tbody>
        </table>
      </div>

      <div class="os-cards-grid" id="osCardsGrid"></div>

    </main>
  </div>

  <div class="modal" id="modalOS"><div class="modal-content" id="modalContentOS"></div></div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="utils.js"></script>

  <script>
    protegerPagina();
    const sidebar = document.getElementById('sidebar');
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const overlay = document.getElementById('overlay');
    mobileMenuBtn.addEventListener('click', () => { sidebar.classList.toggle('is-open'); overlay.classList.toggle('is-open'); });
    overlay.addEventListener('click', () => { sidebar.classList.remove('is-open'); overlay.classList.remove('is-open'); });

    const osRef = database.ref("ordens_servico");
    const clientesRef = database.ref("clientes");
    const estoqueRef = database.ref("estoque");
    const configRef = database.ref('configuracoes');

    let osData = {}, clientesData = {}, estoqueData = {}, configData = {};
    let editandoId = null, pecasSelecionadas = [];
    let filtroStatusAtual = 'em_aberto';

    auth.onAuthStateChanged(user => {
      if (user) {
        configRef.on('value', snap => configData = snap.val() || {});
        clientesRef.on('value', snap => clientesData = snap.val() || {});
        estoqueRef.on('value', snap => estoqueData = snap.val() || {});
        osRef.on('value', snapshot => {
          osData = snapshot.val() || {};
          renderizarConteudo();
        });
      }
    });

    function formatarMoeda(valor) {
        return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor || 0);
    }

    // FUN√á√ÉO PRINCIPAL DE RENDERIZA√á√ÉO ATUALIZADA
    function renderizarConteudo() {
      const osArray = Object.entries(osData).map(([id, data]) => ({ id, ...data }));
      const termoBusca = document.getElementById('searchInput').value.toLowerCase();
      
      let osFiltradas = osArray.filter(os => {
          const buscaMatch = termoBusca === '' ||
              String(os.numeroOS).includes(termoBusca) ||
              os.clienteNome.toLowerCase().includes(termoBusca) ||
              os.aparelho.toLowerCase().includes(termoBusca);

          if (!buscaMatch) return false;

          if (filtroStatusAtual === 'todos') return true;
          if (filtroStatusAtual === 'em_aberto') return ['orcamento', 'aguardando_pecas', 'em_servico'].includes(os.statusOS);
          return os.statusOS === filtroStatusAtual;
      });
      
      osFiltradas.sort((a,b) => b.numeroOS - a.numeroOS);

      const corpoTabela = document.getElementById("osTableBody");
      const gridCards = document.getElementById("osCardsGrid");
      corpoTabela.innerHTML = "";
      gridCards.innerHTML = "";

      if (osFiltradas.length === 0) return;

      osFiltradas.forEach(os => {
        const dataEntrada = new Date(os.dataEntrada + 'T00:00:00Z');
        const diasDesdeEntrada = Math.floor((new Date() - dataEntrada) / (1000 * 60 * 60 * 24));
        let prazoTexto = '';
        if (os.previsaoEntrega) {
          const dataPrazo = new Date(os.previsaoEntrega + 'T00:00:00Z');
          const hoje = new Date(); hoje.setHours(0,0,0,0);
          const diffPrazo = Math.ceil((dataPrazo - hoje) / (1000 * 60 * 60 * 24));
          if (diffPrazo < 0 && !['entregue', 'concluido', 'cancelado'].includes(os.statusOS)) {
            prazoTexto = `<span class="prazo-badge prazo-atrasado">Atrasado ${Math.abs(diffPrazo)}d</span>`;
          } else if (diffPrazo >= 0 && diffPrazo <= 2 && !['entregue', 'concluido', 'cancelado'].includes(os.statusOS)) {
            prazoTexto = `<span class="prazo-badge prazo-urgente">Faltam ${diffPrazo}d</span>`;
          }
        }
        
        let actionButtonsHTML = `<button class="btn-action btn-edit" onclick="editarOS('${os.id}')">‚úèÔ∏è Editar</button>`;
        if (os.statusOS === 'entregue') {
            actionButtonsHTML += `<button class="btn-action btn-reabrir" onclick="reabrirOS('${os.id}')">‚Æå Reabrir</button>`;
        }

        // HTML para a Tabela
        const linha = document.createElement("tr");
        linha.className = `status-row-${os.statusOS}`;
        linha.innerHTML = `
          <td><span class="status-badge status-${os.statusOS}">${os.statusOS.replace("_", " ").toUpperCase()}</span></td>
          <td><strong>#${String(os.numeroOS).padStart(4, '0')}</strong></td>
          <td>${os.clienteNome}<div class="subtext">${os.telefoneCliente}</div></td>
          <td>${os.aparelho}<div class="subtext">${os.marca || ''}</div></td>
          <td>${dataEntrada.toLocaleDateString('pt-BR')} <span class="dias-badge">${diasDesdeEntrada}d</span></td>
          <td>${formatarMoeda(os.valorTotalFinal)} ${prazoTexto}</td>
          <td class="actions-cell">${actionButtonsHTML}</td>
        `;
        corpoTabela.appendChild(linha);

        // HTML para os Cards
        const card = document.createElement('div');
        card.className = 'os-card';
        card.innerHTML = `
            <div class="os-card-header">
                <div class="info">
                    <strong>#${String(os.numeroOS).padStart(4, '0')}</strong>
                    <div class="subtext">${dataEntrada.toLocaleDateString('pt-BR')}</div>
                </div>
                <span class="status-badge status-${os.statusOS}">${os.statusOS.replace("_", " ").toUpperCase()}</span>
            </div>
            <div class="os-card-body">
                <div class="detail"><strong>Cliente:</strong> ${os.clienteNome}</div>
                <div class="detail"><strong>Aparelho:</strong> ${os.aparelho} ${os.marca || ''}</div>
            </div>
            <div class="os-card-footer">
                <div class="os-card-valor">${formatarMoeda(os.valorTotalFinal)}</div>
                <div class="os-card-actions">${actionButtonsHTML}</div>
            </div>
        `;
        gridCards.appendChild(card);
      });
    }

    async function reabrirOS(osId) {
        const os = osData[osId];
        if (!os) {
            alert("Ordem de Servi√ßo n√£o encontrada!");
            return;
        }

        if (!confirm(`Deseja reabrir a OS #${String(os.numeroOS).padStart(4, '0')}?\n\nEsta a√ß√£o ir√°:\n1. EXCLUIR o lan√ßamento do caixa.\n2. Mudar o status da OS para "Conclu√≠do".\n\nVoc√™ poder√° ent√£o finalizar e gerar o pagamento novamente.`)) {
            return;
        }

        try {
            const transacoesSnapshot = await database.ref('transacoes').orderByChild('referenciaOS').equalTo(osId).once('value');
            const transacoes = transacoesSnapshot.val();

            if (transacoes) {
                const transacaoId = Object.keys(transacoes)[0];
                await database.ref('transacoes').child(transacaoId).remove();
            } else {
                console.warn(`Nenhuma transa√ß√£o financeira encontrada para a OS ${osId}, reabrindo mesmo assim.`);
            }

            await osRef.child(osId).update({
                statusOS: 'concluido',
                transacaoGerada: false,
                dataPagamento: null,
                atualizadoEm: new Date().toISOString()
            });

            alert('OS reaberta e transa√ß√£o do caixa exclu√≠da com sucesso!');

        } catch (error) {
            console.error("Erro ao reabrir OS:", error);
            alert("Ocorreu um erro: " + error.message);
        }
    }

    document.getElementById('searchInput').addEventListener('input', renderizarConteudo);
    document.getElementById('tabsOS').addEventListener('click', (e) => {
      if (e.target.classList.contains('tab')) {
        document.querySelectorAll('#tabsOS .tab').forEach(tab => tab.classList.remove('active'));
        e.target.classList.add('active');
        filtroStatusAtual = e.target.dataset.status;
        renderizarConteudo();
      }
    });
    
    // --- FUN√á√ïES DO MODAL ---
    
    function fecharModal() {
        document.getElementById('modalOS').classList.remove('active');
        document.getElementById('modalContentOS').innerHTML = '';
    }

    async function editarOS(id = null) {
        editandoId = id;
        pecasSelecionadas = id ? (osData[id].pecas || []) : [];
        const os = id ? osData[id] : {};
        
        let proximoNumeroOS = 1;
        if (!id) {
            const todasOS = Object.values(osData);
            if (todasOS.length > 0) {
                proximoNumeroOS = Math.max(...todasOS.map(o => o.numeroOS || 0)) + 1;
            }
        }

        const modalContent = document.getElementById('modalContentOS');
        modalContent.innerHTML = `
            <div class="modal-header">
                <h2>${id ? `Editar OS #${String(os.numeroOS).padStart(4, '0')}` : 'Nova Ordem de Servi√ßo'}</h2>
                <button class="btn-close" onclick="fecharModal()">‚úï</button>
            </div>
            <form id="formOS" onsubmit="salvarOS(event)">
                <div class="form-grid">
                    <div>
                        <div class="form-section-title">Dados Principais</div>
                        <div class="form-group" style="position: relative;">
                            <label for="clienteNome">Cliente *</label>
                            <input type="text" id="clienteNome" required value="${os.clienteNome || ''}" placeholder="Digite para buscar..." autocomplete="off">
                            <input type="hidden" id="clienteId" value="${os.clienteId || ''}">
                            <input type="hidden" id="telefoneCliente" value="${os.telefoneCliente || ''}">
                            <div class="suggestions" id="clienteSuggestions"></div>
                        </div>
                        <div class="form-row">
                           <div class="form-group"><label for="aparelho">Aparelho *</label><input type="text" id="aparelho" required value="${os.aparelho || ''}"></div>
                           <div class="form-group"><label for="marca">Marca</label><input type="text" id="marca" value="${os.marca || ''}"></div>
                        </div>
                        <div class="form-group"><label for="defeitoRelatado">Defeito Relatado *</label><textarea id="defeitoRelatado" rows="3" required>${os.defeitoRelatado || ''}</textarea></div>
                        <div class="form-group"><label for="diagnostico">Diagn√≥stico T√©cnico</label><textarea id="diagnostico" rows="3">${os.diagnostico || ''}</textarea></div>
                    </div>
                    <div>
                        <div class="form-section-title">Status e Prazos</div>
                        <div class="form-row">
                            <div class="form-group"><label>N¬∫ OS</label><input type="text" value="#${String(os.numeroOS || proximoNumeroOS).padStart(4, '0')}" readonly></div>
                            <div class="form-group"><label for="statusOS">Status *</label>
                                <select id="statusOS" required>
                                    <option value="orcamento" ${os.statusOS === 'orcamento' ? 'selected' : ''}>Or√ßamento</option>
                                    <option value="aguardando_pecas" ${os.statusOS === 'aguardando_pecas' ? 'selected' : ''}>Aguardando Pe√ßas</option>
                                    <option value="em_servico" ${os.statusOS === 'em_servico' ? 'selected' : ''}>Em Servi√ßo</option>
                                    <option value="concluido" ${os.statusOS === 'concluido' ? 'selected' : ''}>Conclu√≠do</option>
                                    <option value="entregue" ${os.statusOS === 'entregue' ? 'selected' : ''}>Entregue</option>
                                    <option value="cancelado" ${os.statusOS === 'cancelado' ? 'selected' : ''}>Cancelado</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label>Data de Entrada</label><input type="date" value="${os.dataEntrada || new Date().toISOString().slice(0,10)}" readonly></div>
                            <div class="form-group"><label for="previsaoEntrega">Previs√£o de Entrega</label><input type="date" id="previsaoEntrega" value="${os.previsaoEntrega || ''}"></div>
                        </div>
                        <div class="form-group" id="dataPagamentoGroup" style="${os.statusOS === 'entregue' ? '' : 'display:none;'}">
                            <label for="dataPagamento">Data de Pagamento</label>
                            <input type="date" id="dataPagamento" value="${os.dataPagamento || ''}">
                        </div>
                    </div>
                </div>
                
                <div class="form-section-title" style="margin-top: 24px;">Pe√ßas e Valores</div>
                <div class="form-grid">
                    <div>
                        <div class="form-group" style="position: relative;">
                            <label for="pecaSearch">Adicionar Pe√ßa</label>
                            <input type="text" id="pecaSearch" placeholder="Digite para buscar no estoque..." autocomplete="off">
                            <div class="suggestions" id="pecaSuggestions"></div>
                        </div>
                        <div class="pecas-list" id="pecasList"></div>
                    </div>
                    <div class="total-section">
                        <div class="form-group"><label for="valorMaoObra">M√£o de Obra (R$)</label><input type="number" id="valorMaoObra" step="0.01" value="${os.valorMaoObra || 0}"></div>
                        <div class="total-row"><span>Subtotal Pe√ßas:</span><strong id="valorPecas">${formatarMoeda(os.valorPecas)}</strong></div>
                        <div class="form-group"><label for="desconto">Desconto (R$)</label><input type="number" id="desconto" step="0.01" value="${os.desconto || 0}"></div>
                        <hr style="border: none; border-top: 1px solid var(--border-color); margin: 16px 0;">
                        <div class="total-row"><h3>Valor Total:</h3><h3 id="valorTotalFinal">${formatarMoeda(os.valorTotalFinal)}</h3></div>
                        <button type="submit" class="btn-submit">${id ? 'Salvar Altera√ß√µes' : 'Criar Ordem de Servi√ßo'}</button>
                    </div>
                </div>
            </form>
        `;
        document.getElementById('modalOS').classList.add('active');
        setupModalListeners();
        renderizarPecasSelecionadas();
        calcularTotaisOS();
    }

    function setupModalListeners() {
        const clienteInput = document.getElementById('clienteNome');
        const clienteSuggestions = document.getElementById('clienteSuggestions');
        clienteInput.addEventListener('input', () => {
            const termo = clienteInput.value.toLowerCase();
            if (termo.length < 2) { clienteSuggestions.innerHTML = ''; return; }
            const resultados = Object.entries(clientesData).filter(([id, cli]) => cli.nome.toLowerCase().includes(termo));
            clienteSuggestions.innerHTML = resultados.map(([id, cli]) => `<div class="suggestion-item" data-id="${id}" data-nome="${cli.nome}" data-tel="${cli.telefone}">${cli.nome}</div>`).join('');
        });
        clienteSuggestions.addEventListener('click', e => {
            if (e.target.classList.contains('suggestion-item')) {
                clienteInput.value = e.target.dataset.nome;
                document.getElementById('clienteId').value = e.target.dataset.id;
                document.getElementById('telefoneCliente').value = e.target.dataset.tel;
                clienteSuggestions.innerHTML = '';
            }
        });
        
        const pecaInput = document.getElementById('pecaSearch');
        const pecaSuggestions = document.getElementById('pecaSuggestions');
        pecaInput.addEventListener('input', () => {
            const termo = pecaInput.value.toLowerCase();
            if (termo.length < 2) { pecaSuggestions.innerHTML = ''; return; }
            const resultados = Object.entries(estoqueData).filter(([id, p]) => p.nomePeca.toLowerCase().includes(termo) && p.quantidade > 0);
            pecaSuggestions.innerHTML = resultados.map(([id, p]) => `<div class="suggestion-item" data-id="${id}">${p.nomePeca} (${p.quantidade} un.) - ${formatarMoeda(p.valorUnitario)}</div>`).join('');
        });
        pecaSuggestions.addEventListener('click', e => {
            if (e.target.classList.contains('suggestion-item')) {
                const pecaId = e.target.dataset.id;
                const peca = { id: pecaId, ...estoqueData[pecaId] };
                const jaExiste = pecasSelecionadas.find(p => p.id === pecaId);
                if (jaExiste) {
                    jaExiste.quantidade++;
                } else {
                    pecasSelecionadas.push({ id: pecaId, nome: peca.nomePeca, valorUnitario: peca.valorUnitario, quantidade: 1, custo: peca.custo || 0 });
                }
                pecaInput.value = '';
                pecaSuggestions.innerHTML = '';
                renderizarPecasSelecionadas();
                calcularTotaisOS();
            }
        });

        ['valorMaoObra', 'desconto'].forEach(id => document.getElementById(id).addEventListener('input', calcularTotaisOS));
        
        document.getElementById('statusOS').addEventListener('change', e => {
            document.getElementById('dataPagamentoGroup').style.display = e.target.value === 'entregue' ? 'block' : 'none';
        });
    }

    function renderizarPecasSelecionadas() {
        const lista = document.getElementById('pecasList');
        if (!lista) return;
        if (pecasSelecionadas.length === 0) {
            lista.innerHTML = `<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Nenhuma pe√ßa adicionada.</p>`;
            return;
        }
        lista.innerHTML = pecasSelecionadas.map((peca, index) => `
            <div class="peca-item">
                <span style="flex-grow: 1;">${peca.nome}</span>
                <input type="number" value="${peca.quantidade}" min="1" oninput="atualizarQtdPeca(${index}, this.value)" style="width: 60px; text-align: center; padding: 4px;">
                <span>${formatarMoeda(peca.valorUnitario * peca.quantidade)}</span>
                <button type="button" class="btn-delete-peca" onclick="removerPeca(${index})">‚úï</button>
            </div>
        `).join('');
    }

    function atualizarQtdPeca(index, novaQtd) {
        pecasSelecionadas[index].quantidade = parseInt(novaQtd) || 1;
        renderizarPecasSelecionadas();
        calcularTotaisOS();
    }

    function removerPeca(index) {
        pecasSelecionadas.splice(index, 1);
        renderizarPecasSelecionadas();
        calcularTotaisOS();
    }
    
    function calcularTotaisOS() {
        const valorMaoObra = parseFloat(document.getElementById('valorMaoObra').value) || 0;
        const desconto = parseFloat(document.getElementById('desconto').value) || 0;
        const valorPecas = pecasSelecionadas.reduce((total, p) => total + (p.valorUnitario * p.quantidade), 0);
        
        document.getElementById('valorPecas').textContent = formatarMoeda(valorPecas);
        document.getElementById('valorTotalFinal').textContent = formatarMoeda(valorMaoObra + valorPecas - desconto);
    }
    
    async function salvarOS(event) {
        event.preventDefault();
        const osId = editandoId || osRef.push().key;

        const valorMaoObra = parseFloat(document.getElementById('valorMaoObra').value) || 0;
        const valorPecas = pecasSelecionadas.reduce((total, p) => total + (p.valorUnitario * p.quantidade), 0);
        const desconto = parseFloat(document.getElementById('desconto').value) || 0;
        const valorTotalFinal = valorMaoObra + valorPecas - desconto;

        const osAtual = editandoId ? osData[editandoId] : {};
        const proximoNumeroOS = osAtual.numeroOS || (Object.keys(osData).length > 0 ? Math.max(...Object.values(osData).map(o => o.numeroOS)) + 1 : 1);

        const data = {
            clienteId: document.getElementById('clienteId').value,
            clienteNome: document.getElementById('clienteNome').value,
            telefoneCliente: document.getElementById('telefoneCliente').value,
            aparelho: document.getElementById('aparelho').value,
            marca: document.getElementById('marca').value,
            defeitoRelatado: document.getElementById('defeitoRelatado').value,
            diagnostico: document.getElementById('diagnostico').value,
            statusOS: document.getElementById('statusOS').value,
            dataEntrada: osAtual.dataEntrada || new Date().toISOString().slice(0,10),
            previsaoEntrega: document.getElementById('previsaoEntrega').value,
            dataPagamento: document.getElementById('dataPagamento').value || null,
            pecas: pecasSelecionadas,
            valorMaoObra,
            valorPecas,
            desconto,
            valorTotalFinal,
            numeroOS: proximoNumeroOS,
            atualizadoEm: new Date().toISOString(),
            criadoEm: osAtual.criadoEm || new Date().toISOString()
        };
        
        await osRef.child(osId).set(data);
        alert('Ordem de Servi√ßo salva com sucesso!');
        fecharModal();
    }

    document.getElementById('btnNovaOS').addEventListener('click', () => editarOS());

  </script>
</body>
</html>
