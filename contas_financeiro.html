<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Controle Financeiro - SIGO</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: #f0f2f5; min-height: 100vh; }
    header { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; padding: 30px 40px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .header-content { max-width: 1600px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
    .header-left h1 { font-size: 1.8rem; font-weight: 700; margin-bottom: 5px; }
    .header-left p { font-size: 0.9rem; opacity: 0.85; }
    .btn-voltar { background: rgba(255,255,255,0.15); color: white; border: none; padding: 12px 24px; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; }
    .btn-voltar:hover { background: rgba(255,255,255,0.25); transform: translateY(-2px); }
    .container { max-width: 1600px; margin: 30px auto; padding: 0 40px; }
    
    /* Resumo Financeiro - Cards Grandes */
    .resumo-financeiro { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .card-resumo { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); position: relative; overflow: hidden; }
    .card-resumo::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
    .card-resumo.saldo::before { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    .card-resumo.entradas::before { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
    .card-resumo.saidas::before { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
    .card-resumo.mes::before { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
    .card-icon { width: 56px; height: 56px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; margin-bottom: 16px; }
    .card-resumo.saldo .card-icon { background: #d1fae5; }
    .card-resumo.entradas .card-icon { background: #dbeafe; }
    .card-resumo.saidas .card-icon { background: #fee2e2; }
    .card-resumo.mes .card-icon { background: #ede9fe; }
    .card-label { font-size: 0.9rem; color: #6b7280; margin-bottom: 8px; font-weight: 500; }
    .card-valor { font-size: 2.2rem; font-weight: 800; margin-bottom: 8px; }
    .card-resumo.saldo .card-valor { color: #10b981; }
    .card-resumo.entradas .card-valor { color: #3b82f6; }
    .card-resumo.saidas .card-valor { color: #ef4444; }
    .card-resumo.mes .card-valor { color: #8b5cf6; }
    .card-info { font-size: 0.8rem; color: #9ca3af; display: flex; align-items: center; gap: 6px; }
    
    /* Abas de Navega√ß√£o */
    .tabs-container { background: white; border-radius: 16px; padding: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 24px; display: flex; gap: 8px; flex-wrap: wrap; }
    .tab { flex: 1; min-width: 150px; padding: 14px 20px; border: none; background: transparent; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s; color: #6b7280; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .tab.active { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; box-shadow: 0 4px 12px rgba(59,130,246,0.3); }
    .tab:hover:not(.active) { background: #f3f4f6; }
    
    /* Conte√∫do das Abas */
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* Barra de A√ß√µes */
    .actions-bar { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; gap: 20px; flex-wrap: wrap; }
    .filters { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .filter-group { display: flex; flex-direction: column; gap: 4px; }
    .filter-group label { font-size: 0.75rem; color: #6b7280; font-weight: 600; }
    .filter-group select, .filter-group input { padding: 10px 14px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem; transition: all 0.3s; }
    .filter-group select:focus, .filter-group input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
    .btn-primary { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 12px 24px; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(16,185,129,0.3); display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(16,185,129,0.4); }
    .btn-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
    .btn-danger:hover { box-shadow: 0 6px 16px rgba(239,68,68,0.4); }
    
    /* Tabela de Transa√ß√µes */
    .transacoes-table { background: white; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); overflow: hidden; }
    .table-header { background: #f9fafb; padding: 16px 20px; border-bottom: 2px solid #e5e7eb; display: grid; grid-template-columns: 100px 1fr 150px 150px 120px 120px 80px; gap: 16px; font-weight: 700; font-size: 0.85rem; color: #374151; align-items: center; }
    .table-row { padding: 16px 20px; border-bottom: 1px solid #f3f4f6; display: grid; grid-template-columns: 100px 1fr 150px 150px 120px 120px 80px; gap: 16px; align-items: center; transition: all 0.2s; }
    .table-row:hover { background: #f9fafb; }
    .table-row:last-child { border-bottom: none; }
    .tipo-badge { padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-align: center; text-transform: uppercase; }
    .tipo-entrada { background: #dbeafe; color: #1e40af; }
    .tipo-saida { background: #fee2e2; color: #991b1b; }
    .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-align: center; }
    .status-pago { background: #d1fae5; color: #065f46; }
    .status-pendente { background: #fef3c7; color: #92400e; }
    .status-vencido { background: #fee2e2; color: #991b1b; }
    .valor-entrada { color: #10b981; font-weight: 700; font-size: 1.05rem; }
    .valor-saida { color: #ef4444; font-weight: 700; font-size: 1.05rem; }
    .action-buttons { display: flex; gap: 8px; }
    .btn-icon { width: 32px; height: 32px; border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; }
    .btn-edit { background: #dbeafe; color: #1e40af; }
    .btn-edit:hover { background: #3b82f6; color: white; }
    .btn-delete { background: #fee2e2; color: #991b1b; }
    .btn-delete:hover { background: #ef4444; color: white; }
    .btn-pay { background: #d1fae5; color: #065f46; }
    .btn-pay:hover { background: #10b981; color: white; }
    
    /* Modal */
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; padding: 20px; overflow-y: auto; }
    .modal.active { display: block; }
    .modal-content { background: white; border-radius: 20px; padding: 32px; max-width: 800px; width: 100%; margin: 40px auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid #f3f4f6; }
    .modal-header h2 { font-size: 1.5rem; color: #1f2937; display: flex; align-items: center; gap: 12px; }
    .btn-close { background: #f3f4f6; border: none; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; font-size: 1.2rem; transition: all 0.3s; }
    .btn-close:hover { background: #e5e7eb; transform: rotate(90deg); }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 0.9rem; }
    .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 0.95rem; transition: all 0.3s; font-family: inherit; }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
    .form-group textarea { resize: vertical; min-height: 80px; }
    .form-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
    .form-row-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
    .form-actions { display: flex; gap: 12px; margin-top: 28px; }
    .btn-submit { flex: 1; padding: 14px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 1rem; }
    .btn-submit:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(16,185,129,0.4); }
    .btn-cancel { flex: 1; padding: 14px; background: #f3f4f6; color: #374151; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 1rem; }
    .btn-cancel:hover { background: #e5e7eb; }
    
    /* Radio buttons para tipo */
    .tipo-options { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .tipo-option { position: relative; }
    .tipo-option input[type="radio"] { position: absolute; opacity: 0; }
    .tipo-label { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 16px; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer; transition: all 0.3s; font-weight: 600; color: #6b7280; }
    .tipo-option input[type="radio"]:checked + .tipo-label { border-color: #3b82f6; background: #dbeafe; color: #1e40af; }
    .tipo-label:hover { border-color: #3b82f6; background: #f0f9ff; }
    
    /* Estado vazio */
    .empty-state { text-align: center; padding: 80px 20px; background: white; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    .empty-state-icon { font-size: 4rem; margin-bottom: 20px; opacity: 0.5; }
    
    /* Responsividade */
    @media (max-width: 1200px) {
      .table-header, .table-row { grid-template-columns: 90px 1fr 130px 130px 100px 100px 70px; font-size: 0.8rem; }
    }
    @media (max-width: 768px) {
      .container { padding: 0 20px; }
      header { padding: 20px; }
      .header-content { flex-direction: column; gap: 15px; }
      .resumo-financeiro { grid-template-columns: 1fr; }
      .tabs-container { flex-direction: column; }
      .actions-bar { flex-direction: column; align-items: stretch; }
      .table-header { display: none; }
      .table-row { grid-template-columns: 1fr; gap: 8px; padding: 16px; }
      .form-row, .form-row-3 { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="header-left">
        <h1>üí∞ Controle Financeiro</h1>
        <p>Gest√£o completa de entradas, sa√≠das e fluxo de caixa</p>
      </div>
      <button class="btn-voltar" onclick="window.location.href='painel.html'">
        <span>‚Üê</span>
        <span>Voltar</span>
      </button>
    </div>
  </header>

  <div class="container">
    
    <!-- Resumo Financeiro -->
    <div class="resumo-financeiro">
      <div class="card-resumo saldo">
        <div class="card-icon">üíµ</div>
        <div class="card-label">Saldo Atual</div>
        <div class="card-valor" id="saldoAtual">R$ 0,00</div>
        <div class="card-info">üí° Entradas - Sa√≠das</div>
      </div>

      <div class="card-resumo entradas">
        <div class="card-icon">‚¨ÜÔ∏è</div>
        <div class="card-label">Total de Entradas</div>
        <div class="card-valor" id="totalEntradas">R$ 0,00</div>
        <div class="card-info">üìä Todas as entradas</div>
      </div>

      <div class="card-resumo saidas">
        <div class="card-icon">‚¨áÔ∏è</div>
        <div class="card-label">Total de Sa√≠das</div>
        <div class="card-valor" id="totalSaidas">R$ 0,00</div>
        <div class="card-info">üìä Todas as sa√≠das</div>
      </div>

      <div class="card-resumo mes">
        <div class="card-icon">üìÖ</div>
        <div class="card-label">Saldo do M√™s</div>
        <div class="card-valor" id="saldoMes">R$ 0,00</div>
        <div class="card-info" id="mesAtual">üìÜ Janeiro 2025</div>
      </div>
    </div>

    <!-- Abas -->
    <div class="tabs-container">
      <button class="tab active" data-tab="todas">üìã Todas</button>
      <button class="tab" data-tab="entradas">‚¨ÜÔ∏è Entradas</button>
      <button class="tab" data-tab="saidas">‚¨áÔ∏è Sa√≠das</button>
      <button class="tab" data-tab="pendentes">‚è≥ Pendentes</button>
      <button class="tab" data-tab="vencidas">‚ö†Ô∏è Vencidas</button>
    </div>

    <!-- Aba: Todas as Transa√ß√µes -->
    <div class="tab-content active" id="content-todas">
      <div class="actions-bar">
        <div class="filters">
          <div class="filter-group">
            <label>Per√≠odo</label>
            <select id="filtroPeriodo">
              <option value="todos">Todos</option>
              <option value="mes" selected>M√™s Atual</option>
              <option value="semana">√öltima Semana</option>
              <option value="ano">Ano Atual</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Categoria</label>
            <select id="filtroCategoria">
              <option value="todas">Todas</option>
              <option value="servicos">Servi√ßos (OS)</option>
              <option value="fornecedores">Fornecedores</option>
              <option value="salarios">Sal√°rios</option>
              <option value="aluguel">Aluguel</option>
              <option value="energia">Energia</option>
              <option value="outros">Outros</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Data In√≠cio</label>
            <input type="date" id="dataInicio">
          </div>
          <div class="filter-group">
            <label>Data Fim</label>
            <input type="date" id="dataFim">
          </div>
        </div>
        <div style="display: flex; gap: 12px;">
          <button class="btn-primary" id="btnNovaEntrada">
            <span>‚¨ÜÔ∏è</span>
            <span>Nova Entrada</span>
          </button>
          <button class="btn-primary btn-danger" id="btnNovaSaida">
            <span>‚¨áÔ∏è</span>
            <span>Nova Sa√≠da</span>
          </button>
        </div>
      </div>

      <div class="transacoes-table">
        <div class="table-header">
          <div>Data</div>
          <div>Descri√ß√£o</div>
          <div>Categoria</div>
          <div>Vencimento</div>
          <div>Tipo</div>
          <div>Status</div>
          <div>Valor</div>
          <div>A√ß√µes</div>
        </div>
        <div id="transacoesList"></div>
      </div>

      <div class="empty-state" id="emptyState" style="display: none;">
        <div class="empty-state-icon">üí∞</div>
        <h3>Nenhuma transa√ß√£o cadastrada</h3>
        <p>Comece adicionando suas primeiras entradas e sa√≠das</p>
      </div>
    </div>

  </div>

  <!-- Modal de Transa√ß√£o -->
  <div class="modal" id="modalTransacao">
    <div class="modal-content">
      <div class="modal-header">
        <h2><span id="modalIcon">üí∞</span> <span id="modalTitle">Nova Transa√ß√£o</span></h2>
        <button class="btn-close" onclick="fecharModal()">‚úï</button>
      </div>

      <form id="formTransacao" onsubmit="salvarTransacao(event)">
        <input type="hidden" id="transacaoId">

        <div class="form-group">
          <label>Tipo de Transa√ß√£o *</label>
          <div class="tipo-options">
            <div class="tipo-option">
              <input type="radio" id="tipoEntrada" name="tipo" value="entrada" required>
              <label for="tipoEntrada" class="tipo-label">‚¨ÜÔ∏è Entrada</label>
            </div>
            <div class="tipo-option">
              <input type="radio" id="tipoSaida" name="tipo" value="saida">
              <label for="tipoSaida" class="tipo-label">‚¨áÔ∏è Sa√≠da</label>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="descricaoTransacao">Descri√ß√£o *</label>
          <input type="text" id="descricaoTransacao" required placeholder="Ex: Pagamento OS #0023, Fornecedor XYZ">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="categoriaTransacao">Categoria *</label>
            <select id="categoriaTransacao" required>
              <option value="">Selecione...</option>
              <option value="servicos">Servi√ßos (OS)</option>
              <option value="fornecedores">Fornecedores</option>
              <option value="salarios">Sal√°rios</option>
              <option value="aluguel">Aluguel</option>
              <option value="energia">Energia/√Ågua</option>
              <option value="impostos">Impostos</option>
              <option value="outros">Outros</option>
            </select>
          </div>

          <div class="form-group">
            <label for="valorTransacao">Valor (R$) *</label>
            <input type="number" id="valorTransacao" required step="0.01" min="0" placeholder="0.00">
          </div>
        </div>

        <div class="form-row-3">
          <div class="form-group">
            <label for="dataTransacao">Data *</label>
            <input type="date" id="dataTransacao" required>
          </div>

          <div class="form-group">
            <label for="dataVencimento">Vencimento</label>
            <input type="date" id="dataVencimento">
          </div>

          <div class="form-group">
            <label for="statusTransacao">Status *</label>
            <select id="statusTransacao" required>
              <option value="pago">Pago</option>
              <option value="pendente">Pendente</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="formaPagamento">Forma de Pagamento</label>
          <select id="formaPagamento">
            <option value="">Selecione...</option>
            <option value="dinheiro">Dinheiro</option>
            <option value="pix">PIX</option>
            <option value="debito">Cart√£o de D√©bito</option>
            <option value="credito">Cart√£o de Cr√©dito</option>
            <option value="boleto">Boleto</option>
            <option value="transferencia">Transfer√™ncia</option>
          </select>
        </div>

        <div class="form-group">
          <label for="observacoesTransacao">Observa√ß√µes</label>
          <textarea id="observacoesTransacao" placeholder="Informa√ß√µes adicionais..."></textarea>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-cancel" onclick="fecharModal()">Cancelar</button>
          <button type="submit" class="btn-submit">Salvar Transa√ß√£o</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="firebase-config.js"></script>
<script src="utils.js"></script>
 
  <script>
    const auth = firebase.auth();
    const database = firebase.database();
    const transacoesRef = database.ref("transacoes");
    const osRef = database.ref("ordens_servico");

    auth.onAuthStateChanged(user => { if (!user) window.location.href = 'index.html'; });

    let transacoesData = {}, osData = {}, editandoId = null;

    // Carregar dados
    transacoesRef.on("value", snapshot => {
      transacoesData = snapshot.val() || {};
      calcularResumo();
      renderizarTransacoes();
    });

    // Integra√ß√£o: Monitorar OS pagas e criar entradas automaticamente
    osRef.on("value", snapshot => {
      osData = snapshot.val() || {};
      sincronizarOSPagas();
    });

    function sincronizarOSPagas() {
      Object.entries(osData).forEach(([osId, os]) => {
        if (os.statusOS === 'entregue' && os.valorTotalFinal > 0) {
          // Verificar se j√° existe entrada para esta OS
          const jaExiste = Object.values(transacoesData).some(t => 
            t.referenciaOS === osId
          );

          if (!jaExiste) {
            // Criar entrada autom√°tica
            const entradaOS = {
              tipo: 'entrada',
              descricao: `OS #${String(os.numeroOS).padStart(4, '0')} - ${os.clienteNome}`,
              categoria: 'servicos',
              valor: parseFloat(os.valorTotalFinal),
              dataTransacao: os.atualizadoEm ? os.atualizadoEm.split('T')[0] : new Date().toISOString().split('T')[0],
              statusTransacao: 'pago',
              formaPagamento: os.formaPagamento || 'nao_informado',
              observacoes: `Entrada autom√°tica da OS - Aparelho: ${os.aparelho}`,
              referenciaOS: osId,
              numeroOS: os.numeroOS,
              criadoPor: 'sistema',
              criadoEm: new Date().toISOString()
            };

            transacoesRef.push(entradaOS);
          }
        }
      });
    }

    function calcularResumo() {
      const transacoesArray = Object.values(transacoesData);
      
      // Total Entradas
      const totalEntradas = transacoesArray
        .filter(t => t.tipo === 'entrada' && t.statusTransacao === 'pago')
        .reduce((sum, t) => sum + parseFloat(t.valor), 0);
      
      // Total Sa√≠das
      const totalSaidas = transacoesArray
        .filter(t => t.tipo === 'saida' && t.statusTransacao === 'pago')
        .reduce((sum, t) => sum + parseFloat(t.valor), 0);
      
      // Saldo Atual
      const saldoAtual = totalEntradas - totalSaidas;
      
      // Saldo do M√™s
      const hoje = new Date();
      const mesAtual = hoje.getMonth();
      const anoAtual = hoje.getFullYear();
      
      const entradasMes = transacoesArray
        .filter(t => {
          const data = new Date(t.dataTransacao);
          return t.tipo === 'entrada' && 
                 t.statusTransacao === 'pago' && 
                 data.getMonth() === mesAtual && 
                 data.getFullYear() === anoAtual;
        })
        .reduce((sum, t) => sum + parseFloat(t.valor), 0);
      
      const saidasMes = transacoesArray
        .filter(t => {
          const data = new Date(t.dataTransacao);
          return t.tipo === 'saida' && 
                 t.statusTransacao === 'pago' && 
                 data.getMonth() === mesAtual && 
                 data.getFullYear() === anoAtual;
        })
        .reduce((sum, t) => sum + parseFloat(t.valor), 0);
      
      const saldoMes = entradasMes - saidasMes;
      
      // Atualizar interface
      document.getElementById('saldoAtual').textContent = formatarMoeda(saldoAtual);
      document.getElementById('totalEntradas').textContent = formatarMoeda(totalEntradas);
      document.getElementById('totalSaidas').textContent = formatarMoeda(totalSaidas);
      document.getElementById('saldoMes').textContent = formatarMoeda(saldoMes);
      
      const meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                     'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
      document.getElementById('mesAtual').textContent = `üìÜ ${meses[mesAtual]} ${anoAtual}`;
    }

    function formatarMoeda(valor) {
      return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      }).format(valor);
    }

    function renderizarTransacoes() {
      const lista = document.getElementById('transacoesList');
      const emptyState = document.getElementById('emptyState');
      
      lista.innerHTML = '';
      
      let transacoesArray = Object.entries(transacoesData).map(([id, data]) => ({ id, ...data }));
      
      // Aplicar filtros
      const periodo = document.getElementById('filtroPeriodo').value;
      const categoria = document.getElementById('filtroCategoria').value;
      const dataInicio = document.getElementById('dataInicio').value;
      const dataFim = document.getElementById('dataFim').value;
      
      transacoesArray = aplicarFiltros(transacoesArray, periodo, categoria, dataInicio, dataFim);
      
      if (transacoesArray.length === 0) {
        emptyState.style.display = 'block';
        document.querySelector('.transacoes-table').style.display = 'none';
        return;
      }
      
      emptyState.style.display = 'none';
      document.querySelector('.transacoes-table').style.display = 'block';
      
      // Ordenar por data (mais recente primeiro)
      transacoesArray.sort((a, b) => new Date(b.dataTransacao) - new Date(a.dataTransacao));
      
      transacoesArray.forEach(transacao => {
        const row = document.createElement('div');
        row.className = 'table-row';
        
        const data = new Date(transacao.dataTransacao);
        const dataFormatada = data.toLocaleDateString('pt-BR');
        
        const vencimento = transacao.dataVencimento 
          ? new Date(transacao.dataVencimento).toLocaleDateString('pt-BR')
          : '-';
        
        // Verificar se est√° vencido
        let statusClass = `status-${transacao.statusTransacao}`;
        let statusTexto = transacao.statusTransacao === 'pago' ? 'Pago' : 'Pendente';
        
        if (transacao.statusTransacao === 'pendente' && transacao.dataVencimento) {
          const hoje = new Date();
          const dataVenc = new Date(transacao.dataVencimento);
          if (dataVenc < hoje) {
            statusClass = 'status-vencido';
            statusTexto = 'Vencido';
          }
        }
        
        const categoriaTexto = {
          'servicos': 'Servi√ßos (OS)',
          'fornecedores': 'Fornecedores',
          'salarios': 'Sal√°rios',
          'aluguel': 'Aluguel',
          'energia': 'Energia/√Ågua',
          'impostos': 'Impostos',
          'outros': 'Outros'
        }[transacao.categoria] || transacao.categoria;
        
        const valorClass = transacao.tipo === 'entrada' ? 'valor-entrada' : 'valor-saida';
        const valorSinal = transacao.tipo === 'entrada' ? '+' : '-';
        
        row.innerHTML = `
          <div>${dataFormatada}</div>
          <div style="font-weight: 600; color: #1f2937;">
            ${transacao.descricao}
            ${transacao.numeroOS ? `<br><small style="color: #6b7280;">OS #${String(transacao.numeroOS).padStart(4, '0')}</small>` : ''}
          </div>
          <div>${categoriaTexto}</div>
          <div>${vencimento}</div>
          <div><span class="tipo-badge tipo-${transacao.tipo}">${transacao.tipo}</span></div>
          <div><span class="status-badge ${statusClass}">${statusTexto}</span></div>
          <div class="${valorClass}">${valorSinal} ${formatarMoeda(transacao.valor)}</div>
          <div class="action-buttons">
            ${transacao.statusTransacao === 'pendente' ? `
              <button class="btn-icon btn-pay" onclick="marcarComoPago('${transacao.id}')" title="Marcar como pago">
                ‚úì
              </button>
            ` : ''}
            ${!transacao.referenciaOS ? `
              <button class="btn-icon btn-edit" onclick="editarTransacao('${transacao.id}')" title="Editar">
                ‚úé
              </button>
              <button class="btn-icon btn-delete" onclick="excluirTransacao('${transacao.id}', '${transacao.descricao}')" title="Excluir">
                üóë
              </button>
            ` : '<small style="color: #9ca3af;">Auto</small>'}
          </div>
        `;
        
        lista.appendChild(row);
      });
    }

    function aplicarFiltros(transacoes, periodo, categoria, dataInicio, dataFim) {
      let filtradas = [...transacoes];
      
      // Filtro de per√≠odo
      if (periodo !== 'todos') {
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);
        
        filtradas = filtradas.filter(t => {
          const data = new Date(t.dataTransacao);
          data.setHours(0, 0, 0, 0);
          
          if (periodo === 'mes') {
            return data.getMonth() === hoje.getMonth() && 
                   data.getFullYear() === hoje.getFullYear();
          } else if (periodo === 'semana') {
            const umaSemanaAtras = new Date(hoje);
            umaSemanaAtras.setDate(hoje.getDate() - 7);
            return data >= umaSemanaAtras;
          } else if (periodo === 'ano') {
            return data.getFullYear() === hoje.getFullYear();
          }
          return true;
        });
      }
      
      // Filtro de categoria
      if (categoria !== 'todas') {
        filtradas = filtradas.filter(t => t.categoria === categoria);
      }
      
      // Filtro de data personalizada
      if (dataInicio) {
        const inicio = new Date(dataInicio);
        filtradas = filtradas.filter(t => new Date(t.dataTransacao) >= inicio);
      }
      
      if (dataFim) {
        const fim = new Date(dataFim);
        filtradas = filtradas.filter(t => new Date(t.dataTransacao) <= fim);
      }
      
      return filtradas;
    }

    // Abas
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', function() {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        
        const filter = this.dataset.tab;
        filtrarPorAba(filter);
      });
    });

    function filtrarPorAba(filter) {
      const lista = document.getElementById('transacoesList');
      lista.innerHTML = '';
      
      let transacoesArray = Object.entries(transacoesData).map(([id, data]) => ({ id, ...data }));
      
      if (filter === 'entradas') {
        transacoesArray = transacoesArray.filter(t => t.tipo === 'entrada');
      } else if (filter === 'saidas') {
        transacoesArray = transacoesArray.filter(t => t.tipo === 'saida');
      } else if (filter === 'pendentes') {
        transacoesArray = transacoesArray.filter(t => t.statusTransacao === 'pendente');
      } else if (filter === 'vencidas') {
        const hoje = new Date();
        transacoesArray = transacoesArray.filter(t => {
          if (t.statusTransacao !== 'pendente' || !t.dataVencimento) return false;
          return new Date(t.dataVencimento) < hoje;
        });
      }
      
      // Re-renderizar com filtro aplicado
      transacoesData = {};
      transacoesArray.forEach(t => {
        transacoesData[t.id] = t;
      });
      renderizarTransacoes();
      
      // Restaurar dados originais
      transacoesRef.once('value', snapshot => {
        transacoesData = snapshot.val() || {};
      });
    }

    // Modais
    document.getElementById('btnNovaEntrada').addEventListener('click', () => abrirModal('entrada'));
    document.getElementById('btnNovaSaida').addEventListener('click', () => abrirModal('saida'));

    function abrirModal(tipo = 'entrada') {
      editandoId = null;
      document.getElementById('modalTitle').textContent = tipo === 'entrada' ? 'Nova Entrada' : 'Nova Sa√≠da';
      document.getElementById('modalIcon').textContent = tipo === 'entrada' ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è';
      document.getElementById('formTransacao').reset();
      document.getElementById('transacaoId').value = '';
      
      if (tipo === 'entrada') {
        document.getElementById('tipoEntrada').checked = true;
      } else {
        document.getElementById('tipoSaida').checked = true;
      }
      
      document.getElementById('dataTransacao').value = new Date().toISOString().split('T')[0];
      document.getElementById('modalTransacao').classList.add('active');
    }

    function fecharModal() {
      document.getElementById('modalTransacao').classList.remove('active');
      editandoId = null;
    }

    function editarTransacao(id) {
      editandoId = id;
      const transacao = transacoesData[id];
      
      document.getElementById('modalTitle').textContent = 'Editar Transa√ß√£o';
      document.getElementById('modalIcon').textContent = '‚úèÔ∏è';
      document.getElementById('transacaoId').value = id;
      document.getElementById('descricaoTransacao').value = transacao.descricao;
      document.getElementById('categoriaTransacao').value = transacao.categoria;
      document.getElementById('valorTransacao').value = transacao.valor;
      document.getElementById('dataTransacao').value = transacao.dataTransacao;
      document.getElementById('dataVencimento').value = transacao.dataVencimento || '';
      document.getElementById('statusTransacao').value = transacao.statusTransacao;
      document.getElementById('formaPagamento').value = transacao.formaPagamento || '';
      document.getElementById('observacoesTransacao').value = transacao.observacoes || '';
      
      if (transacao.tipo === 'entrada') {
        document.getElementById('tipoEntrada').checked = true;
      } else {
        document.getElementById('tipoSaida').checked = true;
      }
      
      document.getElementById('modalTransacao').classList.add('active');
    }

    function salvarTransacao(event) {
      event.preventDefault();
      
      const tipo = document.querySelector('input[name="tipo"]:checked').value;
      
      const transacaoData = {
        tipo: tipo,
        descricao: document.getElementById('descricaoTransacao').value,
        categoria: document.getElementById('categoriaTransacao').value,
        valor: parseFloat(document.getElementById('valorTransacao').value),
        dataTransacao: document.getElementById('dataTransacao').value,
        dataVencimento: document.getElementById('dataVencimento').value,
        statusTransacao: document.getElementById('statusTransacao').value,
        formaPagamento: document.getElementById('formaPagamento').value,
        observacoes: document.getElementById('observacoesTransacao').value,
        criadoPor: auth.currentUser.email,
        criadoEm: editandoId ? transacoesData[editandoId].criadoEm : new Date().toISOString(),
        atualizadoEm: new Date().toISOString()
      };
      
      if (editandoId) {
        transacoesRef.child(editandoId).update(transacaoData)
          .then(() => {
            alert('Transa√ß√£o atualizada com sucesso!');
            fecharModal();
          })
          .catch(error => alert('Erro ao atualizar: ' + error.message));
      } else {
        transacoesRef.push(transacaoData)
          .then(() => {
            alert('Transa√ß√£o cadastrada com sucesso!');
            fecharModal();
          })
          .catch(error => alert('Erro ao cadastrar: ' + error.message));
      }
    }

    function marcarComoPago(id) {
      const transacao = transacoesData[id];
      if (confirm(`Marcar como pago: ${transacao.descricao}?`)) {
        transacoesRef.child(id).update({
          statusTransacao: 'pago',
          dataPagamento: new Date().toISOString()
        })
        .then(() => alert('Marcado como pago!'))
        .catch(error => alert('Erro: ' + error.message));
      }
    }

    function excluirTransacao(id, descricao) {
      if (confirm(`Deseja realmente excluir:\n"${descricao}"?\n\nEsta a√ß√£o n√£o pode ser desfeita!`)) {
        transacoesRef.child(id).remove()
          .then(() => alert('Transa√ß√£o exclu√≠da com sucesso!'))
          .catch(error => alert('Erro ao excluir: ' + error.message));
      }
    }

    // Event listeners para filtros
    document.getElementById('filtroPeriodo').addEventListener('change', renderizarTransacoes);
    document.getElementById('filtroCategoria').addEventListener('change', renderizarTransacoes);
    document.getElementById('dataInicio').addEventListener('change', renderizarTransacoes);
    document.getElementById('dataFim').addEventListener('change', renderizarTransacoes);

    // Fechar modal ao clicar fora
    document.getElementById('modalTransacao').addEventListener('click', function(e) {
      if (e.target === this) fecharModal();
    });

    // Atalhos de teclado
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') fecharModal();
    });

    console.log('Sistema Financeiro - SIGO Casa dos Reparos - Carregado!');
  </script>
</body>
</html>
