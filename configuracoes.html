<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Configura√ß√µes - SIGO Casa dos Reparos</title>
  
  <style>
    :root {
      --sidebar-bg: #1e293b;
      --sidebar-bg-hover: #334155;
      --main-bg: #e2e8f0;
      --card-bg: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --accent-blue: #3b82f6;
      --accent-red: #ef4444;
      --border-color: #e2e8f0;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--main-bg);
      color: var(--text-primary);
    }

    .dashboard-container {
      display: grid;
      grid-template-columns: 240px 1fr;
      min-height: 100vh;
    }

    /* --- Sidebar de Navega√ß√£o (Estilos copiados do painel.html) --- */
    .sidebar {
      background: var(--sidebar-bg);
      color: #fff;
      display: flex;
      flex-direction: column;
      padding: 24px 16px;
      position: fixed;
      left: 0;
      top: 0;
      height: 100%;
      width: 240px;
      z-index: 100;
      transition: transform 0.3s ease-in-out;
    }

    .sidebar-header { display: flex; align-items: center; gap: 12px; padding-bottom: 24px; margin-bottom: 16px; border-bottom: 1px solid var(--sidebar-bg-hover); }
    .sidebar-logo { width: 40px; height: 40px; background: var(--accent-blue); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; }
    .sidebar-header h1 { font-size: 1.1rem; font-weight: 600; }
    .nav-list { list-style: none; flex-grow: 1; }
    .nav-list a { color: #cbd5e1; text-decoration: none; display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 8px; font-weight: 500; transition: all 0.2s ease-in-out; margin-bottom: 4px; }
    .nav-list a:hover { background: var(--sidebar-bg-hover); color: #fff; }
    .nav-list a.active { background: var(--accent-blue); color: #fff; }
    .nav-icon { font-size: 1.2rem; }
    .sidebar-footer { border-top: 1px solid var(--sidebar-bg-hover); padding-top: 16px; }
    .logout-btn { width: 100%; background: none; border: none; color: #cbd5e1; display: flex; align-items: center; gap: 12px; padding: 12px 16px; font-size: 1rem; cursor: pointer; text-align: left; font-family: inherit; border-radius: 8px; transition: all 0.2s ease-in-out; }
    .logout-btn:hover { background: var(--accent-red); color: #fff; }

    /* --- Conte√∫do Principal --- */
    .main-content {
      grid-column: 2 / 3;
      padding: 32px;
    }

    .main-header {
      margin-bottom: 32px;
    }

    .main-header h1 { font-size: 1.8rem; font-weight: 700; color: var(--text-primary); }
    
    .settings-card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 24px 32px;
      margin-bottom: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    
    .settings-card-title {
      font-size: 1.3rem;
      font-weight: 600;
      padding-bottom: 16px;
      margin-bottom: 24px;
      border-bottom: 1px solid var(--border-color);
    }

    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      border-bottom: 1px solid var(--border-color);
    }
    .setting-item:last-child {
      border-bottom: none;
    }
    
    .setting-item-info h3 {
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 4px;
    }
    .setting-item-info p {
      font-size: 0.9rem;
      color: var(--text-secondary);
      max-width: 500px;
    }
    
    .btn { padding: 10px 20px; border-radius: 8px; border: 1px solid #ccc; background-color: #f0f0f0; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .btn:hover { background-color: #e0e0e0; }
    .btn-primary { background-color: var(--accent-blue); color: white; border-color: var(--accent-blue); }
    .btn-primary:hover { background-color: #2563eb; }
    .btn-danger { background-color: var(--accent-red); color: white; border-color: var(--accent-red); }
    .btn-danger:hover { background-color: #dc2626; }
    
    .danger-zone {
      border: 2px solid var(--accent-red);
    }
    
    .form-group {
        margin-bottom: 16px;
    }
    .form-group label {
        display: block;
        font-weight: 500;
        margin-bottom: 8px;
        font-size: 0.9rem;
    }
    .form-group input, .form-group textarea {
        width: 100%;
        padding: 10px 14px;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 1rem;
    }

    /* --- RESPONSIVIDADE --- */
    .mobile-menu-btn { display: none; background: none; border: none; font-size: 1.8rem; cursor: pointer; }
    .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 99; }
    .overlay.is-open { display: block; }
    @media (max-width: 768px) {
      .dashboard-container { grid-template-columns: 1fr; }
      .sidebar { transform: translateX(-100%); }
      .sidebar.is-open { transform: translateX(0); }
      .main-content { grid-column: 1 / 2; padding: 16px; }
      .mobile-menu-btn { display: block; }
      .setting-item { flex-direction: column; align-items: flex-start; gap: 12px; }
    }
  </style>
</head>
<body>

  <div class="dashboard-container">
    <nav class="sidebar" id="sidebar">
      <div>
        <div class="sidebar-header">
          <div class="sidebar-logo">S</div>
          <h1>SIGO Casa dos Reparos</h1>
        </div>
        
        <ul class="nav-list">
          <li><a href="painel.html"><span class="nav-icon">üè†</span> Painel</a></li>
          <li><a href="ordens-servico.html"><span class="nav-icon">üõ†Ô∏è</span> Ordens de Servi√ßo</a></li>
          <li><a href="clientes.html"><span class="nav-icon">üë•</span> Clientes</a></li>
          <li><a href="agendamentos.html"><span class="nav-icon">üìÖ</span> Agenda</a></li>
          <li><a href="estoque.html"><span class="nav-icon">üì¶</span> Estoque</a></li>
          <li><a href="contas_financeiro.html"><span class="nav-icon">üí∞</span> Financeiro</a></li>
          <li><a href="anotacoes.html"><span class="nav-icon">üìù</span> Anota√ß√µes</a></li>
          <li><a href="configuracoes.html" class="active"><span class="nav-icon">‚öôÔ∏è</span> Configura√ß√µes</a></li>
        </ul>
      </div>
      <div class="sidebar-footer">
        <button class="logout-btn" onclick="logout()">
          <span class="nav-icon">üö™</span> Sair do Sistema
        </button>
      </div>
    </nav>
    
    <div class="overlay" id="overlay"></div>

    <main class="main-content">
      <header class="main-header">
        <h1>Configura√ß√µes do Sistema</h1>
        <button class="mobile-menu-btn" id="mobileMenuBtn">‚ò∞</button>
      </header>

      <section class="settings-card danger-zone">
        <h2 class="settings-card-title">Gerenciamento de Dados</h2>
        
        <div class="setting-item">
          <div class="setting-item-info">
            <h3>Backup Completo</h3>
            <p>Fa√ßa o download de um arquivo com todos os dados do sistema (clientes, OS, estoque, etc.). Guarde em um local seguro.</p>
          </div>
          <button class="btn btn-primary" id="btnBackup">Fazer Backup Agora</button>
        </div>
        
        <div class="setting-item">
          <div class="setting-item-info">
            <h3>Restaurar Backup</h3>
            <p>Substitua todos os dados atuais por um arquivo de backup anterior. <strong>Aten√ß√£o: esta a√ß√£o n√£o pode ser desfeita.</strong></p>
          </div>
          <input type="file" id="inputRestore" accept=".json" style="display: none;">
          <button class="btn" onclick="document.getElementById('inputRestore').click();">Enviar Arquivo</button>
        </div>

        <div class="setting-item">
          <div class="setting-item-info">
            <h3>Limpar Dados Gerais</h3>
            <p>Apaga permanentemente todos os dados do sistema. Use com extremo cuidado, apenas se desejar recome√ßar do zero.</p>
          </div>
          <button class="btn btn-danger" id="btnCleanData">Limpar Todos os Dados</button>
        </div>
      </section>

      <section class="settings-card">
        <h2 class="settings-card-title">Personaliza√ß√£o da Oficina e Perfil</h2>
        
        <div class="form-group">
            <label for="inputNomeOficina">Nome da Oficina</label>
            <input type="text" id="inputNomeOficina" placeholder="Ex: Casa dos Reparos">
        </div>

        <div class="form-group">
            <label for="inputNomeExibicao">Seu Nome de Exibi√ß√£o</label>
            <input type="text" id="inputNomeExibicao" placeholder="Seu nome que aparece no painel">
        </div>
        
        <div style="text-align: right; margin-top: 24px;">
            <button class="btn btn-primary" id="btnSalvarPerfil">Salvar Altera√ß√µes</button>
        </div>
      </section>
      
      </main>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="utils.js"></script>

  <script>
    protegerPagina();

    // --- L√ìGICA DE RESPONSIVIDADE (MENU MOBILE) ---
    const sidebar = document.getElementById('sidebar');
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const overlay = document.getElementById('overlay');
    mobileMenuBtn.addEventListener('click', () => {
        sidebar.classList.toggle('is-open');
        overlay.classList.toggle('is-open');
    });
    overlay.addEventListener('click', () => {
        sidebar.classList.remove('is-open');
        overlay.classList.remove('is-open');
    });

    const configRef = database.ref('configuracoes');

    // --- L√ìGICA DE GERENCIAMENTO DE DADOS ---
    
    // BACKUP
    document.getElementById('btnBackup').addEventListener('click', async () => {
        alert("Iniciando o backup. Isso pode levar um momento.");
        try {
            const snapshot = await database.ref().once('value');
            const data = snapshot.val();
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const dataString = new Date().toISOString().slice(0, 10);
            a.download = `backup-sigo-${dataString}.json`;
            a.click();
            URL.revokeObjectURL(url);
            alert("Backup conclu√≠do com sucesso!");
        } catch (error) {
            alert("Erro ao gerar o backup: " + error.message);
        }
    });

    // RESTAURAR (UPLOAD)
    document.getElementById('inputRestore').addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;

        if (!confirm("‚ö†Ô∏è ATEN√á√ÉO! ‚ö†Ô∏è\n\nVoc√™ tem certeza que deseja restaurar este backup?\n\nTODOS OS DADOS ATUAIS SER√ÉO APAGADOS E SUBSTITU√çDOS PELOS DADOS DO ARQUIVO.\n\nEsta a√ß√£o √© irrevers√≠vel.")) {
            event.target.value = ''; // Limpa o input
            return;
        }

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = JSON.parse(e.target.result);
                await database.ref().set(data);
                alert("Backup restaurado com sucesso! A p√°gina ser√° recarregada.");
                window.location.reload();
            } catch (error) {
                alert("Erro ao ler o arquivo de backup. Verifique se o arquivo √© v√°lido.\n\n" + error.message);
            }
        };
        reader.readAsText(file);
    });

    // LIMPAR DADOS
    document.getElementById('btnCleanData').addEventListener('click', async () => {
        const confirmacao1 = prompt("Esta a√ß√£o apagar√° TODOS os seus dados permanentemente. Para confirmar, digite 'CONFIRMAR EXCLUSAO' na caixa abaixo:");
        if (confirmacao1 !== "CONFIRMAR EXCLUSAO") {
            alert("A√ß√£o cancelada. A frase de confirma√ß√£o n√£o corresponde.");
            return;
        }

        if (!confirm("√öLTIMO AVISO:\n\nTodos os seus clientes, ordens de servi√ßo, estoque e dados financeiros ser√£o exclu√≠dos. Deseja realmente continuar?")) {
            alert("A√ß√£o cancelada.");
            return;
        }
        
        try {
            alert("Limpando dados... O sistema ser√° recarregado em seguida.");
            await database.ref().remove();
            alert("Todos os dados foram exclu√≠dos.");
            window.location.reload();
        } catch (error) {
            alert("Ocorreu um erro ao limpar os dados: " + error.message);
        }
    });

    // --- L√ìGICA DE PERSONALIZA√á√ÉO ---
    const inputNomeOficina = document.getElementById('inputNomeOficina');
    const inputNomeExibicao = document.getElementById('inputNomeExibicao');
    
    // Carregar configura√ß√µes salvas
    configRef.on('value', (snapshot) => {
        const config = snapshot.val() || {};
        inputNomeOficina.value = config.nomeOficina || '';
        inputNomeExibicao.value = config.nomeExibicao || '';
    });

    // Salvar configura√ß√µes
    document.getElementById('btnSalvarPerfil').addEventListener('click', async () => {
        const user = auth.currentUser;
        if (!user) return;
        
        try {
            // Atualiza o nome de exibi√ß√£o no Firebase Auth (se alterado)
            if (user.displayName !== inputNomeExibicao.value) {
                await user.updateProfile({ displayName: inputNomeExibicao.value });
            }
            
            // Salva as configura√ß√µes no Realtime Database
            await configRef.update({
                nomeOficina: inputNomeOficina.value,
                nomeExibicao: inputNomeExibicao.value
            });
            
            alert("Configura√ß√µes salvas com sucesso!");
        } catch (error) {
            alert("Erro ao salvar configura√ß√µes: " + error.message);
        }
    });

  </script>
</body>
</html>
