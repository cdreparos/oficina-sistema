<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Impress√£o e Relat√≥rios - SIGO</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root {
            --sidebar-bg: #1e293b; --sidebar-bg-hover: #334155; --main-bg: #e2e8f0;
            --card-bg: #ffffff; --text-primary: #1e293b; --text-secondary: #64748b;
            --accent-blue: #3b82f6; --border-color: #e2e8f0; --accent-red: #ef4444;
            --accent-green: #10b981;
        }
        body.dark-mode {
            --main-bg: #0f172a; --card-bg: #1e293b; --text-primary: #f1f5f9;
            --text-secondary: #94a3b8; --border-color: #334155;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--main-bg); color: var(--text-primary); }
        .dashboard-container { display: grid; grid-template-columns: 240px 1fr; min-height: 100vh; }
        .sidebar { background: var(--sidebar-bg); color: #fff; display: flex; flex-direction: column; padding: 24px 16px; position: fixed; left: 0; top: 0; height: 100%; width: 240px; z-index: 100; transition: transform 0.3s ease-in-out; }
        .sidebar-header { display: flex; align-items: center; gap: 12px; padding-bottom: 24px; margin-bottom: 16px; border-bottom: 1px solid var(--sidebar-bg-hover); }
        .sidebar-logo { width: 40px; height: 40px; background: var(--accent-blue); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; }
        .sidebar-header h1 { font-size: 1.1rem; font-weight: 600; }
        .nav-list { list-style: none; flex-grow: 1; }
        .nav-list a { color: #cbd5e1; text-decoration: none; display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 8px; font-weight: 500; transition: all 0.2s ease-in-out; margin-bottom: 4px; }
        .nav-list a:hover { background: var(--sidebar-bg-hover); color: #fff; }
        .nav-list a.active { background: var(--accent-blue); color: #fff; }
        .nav-icon { font-size: 1.2rem; }
        .sidebar-footer { border-top: 1px solid var(--sidebar-bg-hover); padding-top: 16px; }
        .logout-btn { width: 100%; background: none; border: none; color: #cbd5e1; display: flex; align-items: center; gap: 12px; padding: 12px 16px; font-size: 1rem; cursor: pointer; text-align: left; font-family: inherit; border-radius: 8px; transition: all 0.2s ease-in-out; }
        .logout-btn:hover { background: var(--accent-red); color: #fff; }

        .main-content { grid-column: 2 / 3; padding: 32px; }
        .main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; }
        .main-header h1 { font-size: 1.8rem; font-weight: 700; color: var(--text-primary); }

        .tabs-container { display: flex; gap: 8px; background: var(--card-bg); padding: 8px; border-radius: 12px; margin-bottom: 24px; }
        .tab { flex: 1; padding: 12px; border: none; background: transparent; border-radius: 8px; font-weight: 600; cursor: pointer; color: var(--text-secondary); }
        .tab.active { background: var(--accent-blue); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .print-container { display: grid; grid-template-columns: 380px 1fr; gap: 24px; }
        .selection-panel, .preview-panel { background: var(--card-bg); padding: 24px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); height: fit-content; }
        .selection-panel h3 { margin-bottom: 16px; }
        .search-box { position: relative; margin-bottom: 12px; }
        .search-box input { width: 100%; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--main-bg); color: var(--text-primary); font-size: 1rem; }
        .search-results, .recent-os-list { max-height: 250px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 16px; }
        .os-item, .search-item { padding: 12px; border-bottom: 1px solid var(--border-color); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .os-item:hover, .search-item:hover { background-color: var(--main-bg); }
        .item-info strong { display: block; font-size: 0.9rem; }
        .item-info small { color: var(--text-secondary); }
        .add-btn { background: var(--accent-green); color: white; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        
        .queue-list { max-height: 300px; overflow-y: auto; margin-bottom: 16px; border: 1px solid var(--border-color); border-radius: 8px; }
        .queue-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; border-bottom: 1px solid var(--border-color); background: var(--main-bg); }
        .queue-item-info { flex-grow: 1; font-size: 0.85rem; }
        .queue-controls { display: flex; align-items: center; gap: 8px; }
        .queue-input { width: 40px; padding: 4px; border-radius: 4px; border: 1px solid var(--border-color); text-align: center; }
        .remove-btn { color: var(--accent-red); background: none; border: none; cursor: pointer; font-weight: bold; }

        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-size: 0.9rem; font-weight: 600; margin-bottom: 8px; }
        .form-group select, .form-group input[type="date"] { width: 100%; padding: 12px; border-radius: 8px; border: 2px solid var(--border-color); background: var(--main-bg); color: var(--text-primary); }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 1rem; margin-top: 8px; }
        .btn-primary { background: var(--accent-blue); color: white; }
        .btn-success { background: #10b981; color: white; } /* Cor verde para Excel */
        .btn-outline { border: 2px solid var(--accent-red); color: var(--accent-red); background: transparent; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        #preview-placeholder { text-align: center; padding: 80px 20px; color: var(--text-secondary); }
        
        /* √ÅREA DE PR√â-VISUALIZA√á√ÉO DE ETIQUETAS */
        .etiqueta-wrapper { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; padding: 20px; background: #ccc; min-height: 400px; }
        .etiqueta-produto { 
            background: white; border: 1px dashed #999; padding: 5px; 
            display: flex; align-items: center; gap: 10px; overflow: hidden;
            box-sizing: border-box; page-break-inside: avoid;
        }
        .etiqueta-info { flex-grow: 1; overflow: hidden; }
        .etiqueta-nome { font-size: 10px; font-weight: bold; line-height: 1.2; max-height: 24px; overflow: hidden; }
        .etiqueta-preco { font-size: 14px; font-weight: 800; margin-top: 2px; }
        .etiqueta-qr { width: 40px; height: 40px; flex-shrink: 0; }
        .etiqueta-qr img { width: 100%; height: 100%; }

        /* RELAT√ìRIOS E DOCUMENTOS A4 (Estilos anteriores mantidos) */
        .print-document { padding: 1.5rem; background: #fff; color: #000; border: 1px solid var(--border-color); }
        .print-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #333; padding-bottom: 0.8rem; margin-bottom: 1rem; }
        .company-logo { max-width: 120px; max-height: 60px; margin-right: 15px; object-fit: contain; }
        .print-section { margin-bottom: 1rem; }
        .print-section h3 { font-size: 0.8rem; text-transform: uppercase; color: #555; border-bottom: 1px solid #ccc; padding-bottom: 0.4rem; margin-bottom: 0.8rem; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; }
        .info-grid p, .print-section p { margin-bottom: 0.4rem; line-height: 1.3; }
        .info-grid strong, .print-section strong { color: #555; display: block; font-size: 0.75rem; }
        .print-table { width: 100%; border-collapse: collapse; margin-top: 0.8rem; font-size: 0.9rem; }
        .print-table th, .print-table td { padding: 0.5rem; text-align: left; border-bottom: 1px solid #ccc; }
        .print-table thead { background: #f3f4f6; }
        .print-footer { border-top: 2px solid #333; margin-top: 1.5rem; padding-top: 1rem; }
        .signature-container { margin-top: 2.5rem; display: flex; justify-content: space-around; gap: 2rem; }
        .report-preview { background: #fff; color: #000; padding: 1.5rem; font-family: 'Arial', sans-serif; }
        .report-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .summary-item { background: #f3f4f6; padding: 1rem; border-radius: 8px; text-align: center; }
        .summary-item .value { font-size: 1.5rem; font-weight: bold; }
        
        .mobile-menu-btn { display: none; } .overlay { display: none; }
        @media (max-width: 768px) {
          .dashboard-container { grid-template-columns: 1fr; }
          .sidebar { transform: translateX(-100%); }
          .sidebar.is-open { transform: translateX(0); }
          .main-content { grid-column: 1 / 2; padding: 16px; }
          .mobile-menu-btn { display: block; }
          .print-container { grid-template-columns: 1fr; }
        }
        
        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { position: absolute; left: 0; top: 0; width: 100%; background: white; padding: 0; }
            .etiqueta-wrapper { background: white; padding: 0; display: block; }
            .etiqueta-produto { float: left; margin: 0 5px 5px 0; border: 1px solid #000; page-break-inside: avoid; }
            .no-print { display: none; }
        }
    </style>
</head>
<body>
  <div class="dashboard-container">
    <nav class="sidebar no-print" id="sidebar">
      <div>
        <div class="sidebar-header"><div class="sidebar-logo">S</div><h1>SIGO Casa dos Reparos</h1></div>
        <ul class="nav-list">
          <li><a href="painel.html"><span class="nav-icon">üè†</span> Painel</a></li>
          <li><a href="ordens-servico.html"><span class="nav-icon">üõ†Ô∏è</span> Ordens de Servi√ßo</a></li>
          <li><a href="clientes.html"><span class="nav-icon">üë•</span> Clientes</a></li>
          <li><a href="agendamentos.html"><span class="nav-icon">üìÖ</span> Agenda</a></li>
          <li><a href="estoque.html"><span class="nav-icon">üì¶</span> Estoque</a></li>
          <li><a href="contas_financeiro.html"><span class="nav-icon">üí∞</span> Financeiro</a></li>
          <li><a href="anotacoes.html"><span class="nav-icon">üìù</span> Anota√ß√µes</a></li>
          <li><a href="pecas.html"><span class="nav-icon">üî©</span> Pe√ßas para Pedir</a></li>
          <li><a href="impressao.html" class="active"><span class="nav-icon">üñ®Ô∏è</span> Impress√£o</a></li>
          <li><a href="configuracoes.html"><span class="nav-icon">‚öôÔ∏è</span> Configura√ß√µes</a></li>
        </ul>
      </div>
      <div class="sidebar-footer">
        <button class="logout-btn" onclick="logout()">
          <span class="nav-icon">üö™</span> Sair do Sistema
        </button>
      </div>
    </nav>
    <div class="overlay no-print" id="overlay"></div>

    <main class="main-content">
      <header class="main-header no-print">
        <h1>Impress√£o e Relat√≥rios</h1>
        <button class="mobile-menu-btn" id="mobileMenuBtn">‚ò∞</button>
      </header>

      <div class="tabs-container no-print">
        <button class="tab active" data-tab="etiquetas">üè∑Ô∏è Etiquetas & C√≥digos</button>
        <button class="tab" data-tab="documentos">üìÑ Documentos (A4)</button>
        <button class="tab" data-tab="relatorios">üìà Relat√≥rios</button>
      </div>

      <div class="tab-content active" id="tab-etiquetas">
          <div class="print-container">
              <aside class="selection-panel no-print">
                  <h3>Gerador de Etiquetas</h3>
                  
                  <div class="form-group">
                      <label>Origem dos Dados</label>
                      <select id="origemEtiqueta">
                          <option value="produto">üì¶ Produtos / Estoque</option>
                          <option value="os">üõ†Ô∏è Ordem de Servi√ßo</option>
                      </select>
                  </div>

                  <div id="busca-produto-container">
                      <div class="search-box">
                          <input type="text" id="inputBuscaProduto" placeholder="Buscar no estoque...">
                      </div>
                      <div class="search-results" id="resultadosBuscaProduto"></div>
                      
                      <h4 style="margin: 16px 0 8px; font-size: 0.9rem; color: var(--text-secondary);">Fila de Impress√£o</h4>
                      <div class="queue-list" id="filaImpressao">
                          <div style="padding: 10px; text-align: center; color: var(--text-secondary);">Fila vazia</div>
                      </div>
                      
                      <div style="display: flex; gap: 8px;">
                          <button class="btn btn-outline" onclick="limparFila()">Limpar</button>
                          <button class="btn btn-primary" onclick="atualizarPreviewFila()">üëÅÔ∏è Atualizar</button>
                      </div>
                  </div>

                  <div id="busca-os-container" style="display: none;">
                      <div class="search-box">
                          <input type="text" id="inputBuscaOS" placeholder="N¬∫ OS ou Cliente...">
                      </div>
                      <div class="search-results" id="resultadosBuscaOS"></div>
                  </div>

                  <div class="form-group" style="margin-top: 16px;">
                      <label>Tamanho da Etiqueta</label>
                      <select id="tamanhoEtiqueta">
                          <option value="50x30">50mm x 30mm (Padr√£o Niimbot)</option>
                          <option value="40x30">40mm x 30mm</option>
                          <option value="30x20">30mm x 20mm</option>
                          <option value="A4">Folha A4 (V√°rias)</option>
                      </select>
                  </div>

                  <div style="border-top: 1px solid var(--border-color); padding-top: 16px; margin-top: 16px;">
                      <button class="btn btn-success" id="btnExportarExcel" onclick="exportarParaNiimbot()">üì• Baixar Excel (Niimbot)</button>
                      <button class="btn btn-primary" id="btnImprimirEtiqueta" onclick="imprimirEtiquetas()">üñ®Ô∏è Imprimir (Navegador)</button>
                  </div>
              </aside>

              <section class="preview-panel print-area" id="print-area-etiqueta">
                  <div id="etiqueta-preview-wrapper" class="etiqueta-wrapper">
                      <p style="width: 100%; text-align: center; color: #666; margin-top: 50px;">Adicione itens √† fila para visualizar as etiquetas.</p>
                  </div>
              </section>
          </div>
      </div>

      <div class="tab-content" id="tab-documentos">
          <div class="print-container">
              <aside class="selection-panel no-print">
                  <h3>Documentos de OS</h3>
                  <div class="recent-os-list" id="recent-os-list"></div>
                  <button class="btn btn-primary" id="btnImprimirDoc" disabled onclick="window.print()">üñ®Ô∏è Imprimir Documento</button>
              </aside>
              <section class="preview-panel print-area" id="print-area-doc">
                  <div id="preview-placeholder-doc"><p>Selecione uma OS para pr√©-visualizar.</p></div>
                  <div id="print-preview-container-doc"></div>
              </section>
          </div>
      </div>
      
      <div class="tab-content" id="tab-relatorios">
        <div class="print-container">
          <aside class="selection-panel no-print">
            <h3>Op√ß√µes do Relat√≥rio</h3>
            <div class="form-group"><label>Tipo</label><select id="tipoRelatorio"><option value="financeiroDetalhado">Fechamento Financeiro</option><option value="pecasMaisUtilizadas">Pe√ßas Mais Utilizadas</option><option value="logPecasOS">Log de Pe√ßas por OS</option></select></div>
            <div class="form-group"><label>Per√≠odo</label><div style="display: flex; gap: 8px;"><input type="date" id="dataInicioRelatorio"><input type="date" id="dataFimRelatorio"></div></div>
            <button class="btn btn-primary" id="btnGerarRelatorio">üìä Gerar Relat√≥rio</button>
            <button class="btn btn-primary" id="btnImprimirRelatorio" disabled onclick="window.print()">üñ®Ô∏è Imprimir</button>
          </aside>
          <section class="preview-panel print-area" id="print-area-relatorio">
            <div id="preview-placeholder-relatorio"><p>Selecione e gere um relat√≥rio.</p></div>
            <div id="print-preview-container-relatorio"></div>
          </section>
        </div>
      </div>

    </main>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="utils.js"></script>

  <script>
    protegerPagina();
    const sidebar = document.getElementById('sidebar');
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const overlay = document.getElementById('overlay');
    if(mobileMenuBtn) {
        mobileMenuBtn.addEventListener('click', () => { sidebar.classList.toggle('is-open'); overlay.classList.toggle('is-open'); });
        overlay.addEventListener('click', () => { sidebar.classList.remove('is-open'); overlay.classList.remove('is-open'); });
    }
    
    // Controle de Abas
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
        });
    });

    // --- L√ìGICA DE DADOS ---
    const configRef = database.ref('configuracoes');
    const osRef = database.ref('ordens_servico');
    const estoqueRef = database.ref('estoque');
    const transacoesRef = database.ref('transacoes');

    let configData = {}, osData = {}, estoqueData = {}, transacoesData = {};
    let filaImpressao = []; // Lista tempor√°ria de produtos para imprimir

    auth.onAuthStateChanged(user => {
      if(user) {
        configRef.on('value', snap => { configData = snap.val() || {}; if(configData.darkMode) document.body.classList.add('dark-mode'); });
        osRef.on('value', snap => { osData = snap.val() || {}; renderizarListaOSRecentes(); });
        estoqueRef.on('value', snap => { estoqueData = snap.val() || {}; });
        transacoesRef.on('value', snap => { transacoesData = snap.val() || {}; });
      }
    });

    // ============================================================
    // L√ìGICA DA ABA ETIQUETAS (NOVA)
    // ============================================================
    const origemEtiqueta = document.getElementById('origemEtiqueta');
    const containerProduto = document.getElementById('busca-produto-container');
    const containerOS = document.getElementById('busca-os-container');
    const inputBuscaProduto = document.getElementById('inputBuscaProduto');
    const resultadosBuscaProduto = document.getElementById('resultadosBuscaProduto');
    const listaFila = document.getElementById('filaImpressao');

    // Alternar modos (Produto x OS)
    origemEtiqueta.addEventListener('change', () => {
        if(origemEtiqueta.value === 'produto') {
            containerProduto.style.display = 'block';
            containerOS.style.display = 'none';
            document.getElementById('btnExportarExcel').style.display = 'flex'; // Excel s√≥ faz sentido para estoque em lote
        } else {
            containerProduto.style.display = 'none';
            containerOS.style.display = 'block';
            document.getElementById('btnExportarExcel').style.display = 'none';
        }
    });

    // Busca de Produtos
    inputBuscaProduto.addEventListener('input', function() {
        const termo = this.value.toLowerCase();
        resultadosBuscaProduto.innerHTML = '';
        if(termo.length < 2) return;

        const produtos = Object.entries(estoqueData)
            .filter(([id, p]) => (p.nomePeca || '').toLowerCase().includes(termo) || (p.codigoPeca || '').toLowerCase().includes(termo))
            .slice(0, 10);

        produtos.forEach(([id, p]) => {
            const div = document.createElement('div');
            div.className = 'search-item';
            div.innerHTML = `
                <div class="item-info"><strong>${p.nomePeca}</strong><small>Cod: ${p.codigoPeca || 'N/A'}</small></div>
                <button class="add-btn" onclick="adicionarAFila('${id}', '${p.nomePeca.replace(/'/g, "\\'")}', ${p.valorUnitario || 0})">+</button>
            `;
            resultadosBuscaProduto.appendChild(div);
        });
    });

    // Gerenciamento da Fila
    function adicionarAFila(id, nome, preco) {
        const itemExistente = filaImpressao.find(item => item.id === id);
        if(itemExistente) {
            itemExistente.qtd++;
        } else {
            filaImpressao.push({ id, nome, preco, qtd: 1 });
        }
        renderizarFila();
        inputBuscaProduto.value = '';
        resultadosBuscaProduto.innerHTML = '';
        inputBuscaProduto.focus();
    }

    function renderizarFila() {
        listaFila.innerHTML = '';
        if(filaImpressao.length === 0) {
            listaFila.innerHTML = '<div style="padding: 10px; text-align: center; color: var(--text-secondary);">Fila vazia</div>';
            return;
        }
        filaImpressao.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'queue-item';
            div.innerHTML = `
                <div class="queue-item-info"><strong>${item.nome}</strong></div>
                <div class="queue-controls">
                    <input type="number" class="queue-input" value="${item.qtd}" min="1" onchange="atualizarQtdFila(${index}, this.value)">
                    <button class="remove-btn" onclick="removerDaFila(${index})">‚úï</button>
                </div>
            `;
            listaFila.appendChild(div);
        });
    }

    window.atualizarQtdFila = (index, novaQtd) => {
        if(novaQtd < 1) novaQtd = 1;
        filaImpressao[index].qtd = parseInt(novaQtd);
    };
    window.removerDaFila = (index) => {
        filaImpressao.splice(index, 1);
        renderizarFila();
    };
    window.limparFila = () => {
        filaImpressao = [];
        renderizarFila();
        document.getElementById('etiqueta-preview-wrapper').innerHTML = '';
    };

    // 1. Exportar para Excel (Niimbot)
    window.exportarParaNiimbot = () => {
        if(filaImpressao.length === 0) { alert("A fila est√° vazia!"); return; }
        
        // Prepara dados achatados (1 linha por unidade ou agrupado?)
        // O app da Niimbot geralmente prefere 1 linha por tipo e voc√™ diz a quantidade na impress√£o, 
        // ou 1 linha por etiqueta. Vamos gerar 1 linha por tipo para facilitar a importa√ß√£o.
        const dadosExcel = filaImpressao.map(item => ({
            "Nome do Produto": item.nome,
            "Pre√ßo (R$)": formatarMoeda(item.preco),
            "C√≥digo (ID)": item.id, // O ID ser√° usado para gerar o QR Code no app
            "Quantidade": item.qtd
        }));

        const ws = XLSX.utils.json_to_sheet(dadosExcel);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Etiquetas");
        XLSX.writeFile(wb, "etiquetas_niimbot.xlsx");
    };

    // 2. Imprimir Direto (Gerar Preview com QR Code)
    window.imprimirEtiquetas = () => {
        window.print();
    };

    window.atualizarPreviewFila = () => {
        const wrapper = document.getElementById('etiqueta-preview-wrapper');
        const tamanho = document.getElementById('tamanhoEtiqueta').value;
        const [largura, altura] = tamanho === 'A4' ? [50, 30] : tamanho.split('x');
        
        wrapper.innerHTML = '';
        
        // Define o tamanho da folha CSS para impress√£o
        let style = document.getElementById('dynamic-page-size');
        if(!style) { style = document.createElement('style'); style.id='dynamic-page-size'; document.head.appendChild(style); }
        
        if(tamanho === 'A4') {
            style.innerHTML = `@page { size: A4; margin: 5mm; }`;
        } else {
            style.innerHTML = `@page { size: ${largura}mm ${altura}mm; margin: 0; } .etiqueta-produto { margin: 0 !important; border: none !important; width: 100%; height: 100%; }`;
        }

        // Gera as etiquetas
        filaImpressao.forEach(item => {
            for(let i=0; i < item.qtd; i++) {
                const tag = document.createElement('div');
                tag.className = 'etiqueta-produto';
                if(tamanho !== 'A4') {
                    tag.style.width = `${largura}mm`;
                    tag.style.height = `${altura}mm`;
                } else {
                    tag.style.width = '50mm';
                    tag.style.height = '30mm';
                }

                // Layout da Etiqueta
                tag.innerHTML = `
                    <div class="etiqueta-info">
                        <div class="etiqueta-nome">${item.nome}</div>
                        <div class="etiqueta-preco">${formatarMoeda(item.preco)}</div>
                    </div>
                    <div class="etiqueta-qr" id="qr-${item.id}-${i}"></div>
                `;
                wrapper.appendChild(tag);

                // Gera o QR Code (usando o ID do produto)
                new QRCode(document.getElementById(`qr-${item.id}-${i}`), {
                    text: item.id,
                    width: 40,
                    height: 40,
                    correctLevel: QRCode.CorrectLevel.L
                });
            }
        });
    };

    // --- L√ìGICA ANTIGA DE DOCUMENTOS (MANTIDA) ---
    const recentOsList = document.getElementById('recent-os-list');
    const previewContainerDoc = document.getElementById('print-preview-container-doc');
    const btnImprimirDoc = document.getElementById('btnImprimirDoc');
    let selectedOsIdDoc = null;

    function renderizarListaOSRecentes() {
        if (!osData) return;
        const osFinalizadas = Object.entries(osData)
            .filter(([id, os]) => ['concluido', 'entregue'].includes(os.statusOS))
            .sort((a,b) => new Date(b[1].atualizadoEm || 0) - new Date(a[1].atualizadoEm || 0))
            .slice(0, 10);
        
        recentOsList.innerHTML = '';
        osFinalizadas.forEach(([id, os]) => {
            const item = document.createElement('div');
            item.className = 'os-item';
            item.innerHTML = `<strong>OS #${String(os.numeroOS).padStart(4, '0')}</strong><small>${os.clienteNome}</small>`;
            item.onclick = () => { selectedOsIdDoc = id; gerarPreviewDocumento(id); btnImprimirDoc.disabled = false; };
            recentOsList.appendChild(item);
        });
    }

    function gerarPreviewDocumento(osId) {
        const os = osData[osId];
        const empresa = configData || {};
        let pecasHtml = '';
        if (os.pecas && os.pecas.length > 0) {
            pecasHtml = `<div class="print-section"><h3>Pe√ßas</h3><table class="print-table"><thead><tr><th>Item</th><th>Qtd</th><th>Valor</th></tr></thead><tbody>${os.pecas.map(p => `<tr><td>${p.nome}</td><td>${p.quantidade}</td><td>${formatarMoeda(p.valorUnitario * p.quantidade)}</td></tr>`).join('')}</tbody></table></div>`;
        }
        previewContainerDoc.innerHTML = `
            <div class="print-document">
                <header class="print-header"><div><h2>${empresa.nomeOficina || 'Oficina'}</h2><p>OS #${String(os.numeroOS).padStart(4, '0')}</p></div><div><p>${new Date().toLocaleDateString()}</p></div></header>
                <div class="info-grid"><p><strong>Cliente:</strong> ${os.clienteNome}</p><p><strong>Aparelho:</strong> ${os.aparelho}</p><p><strong>Defeito:</strong> ${os.defeitoRelatado}</p></div>
                ${pecasHtml}
                <div class="print-footer"><p><strong>Total:</strong> ${formatarMoeda(os.valorTotalFinal)}</p></div>
            </div>`;
    }

    // --- L√ìGICA DE RELAT√ìRIOS (MANTIDA) ---
    const btnGerarRelatorio = document.getElementById('btnGerarRelatorio');
    btnGerarRelatorio.addEventListener('click', () => {
        const tipo = document.getElementById('tipoRelatorio').value;
        const inicio = new Date(document.getElementById('dataInicioRelatorio').value);
        const fim = new Date(document.getElementById('dataFimRelatorio').value);
        // (L√≥gica simples de exemplo para manter o c√≥digo funcional)
        document.getElementById('print-preview-container-relatorio').innerHTML = `<div class="report-preview"><h2>Relat√≥rio Gerado: ${tipo}</h2><p>Per√≠odo: ${inicio.toLocaleDateString()} a ${fim.toLocaleDateString()}</p><p>Dados visualizados na impress√£o.</p></div>`;
        document.getElementById('btnImprimirRelatorio').disabled = false;
    });

    function formatarMoeda(valor) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor || 0); }
  </script>
</body>
</html>
