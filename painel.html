<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel - SIGO Casa dos Reparos</title>
  
  <style>
    :root {
      --sidebar-bg: #1e293b;
      --sidebar-bg-hover: #334155;
      --main-bg: #e2e8f0;
      --card-bg: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --accent-blue: #3b82f6;
      --accent-green: #10b981;
      --accent-yellow: #f59e0b;
      --accent-red: #ef4444;
      --border-color: #e2e8f0;
    }

    body.dark-mode {
        --main-bg: #0f172a;
        --card-bg: #1e293b;
        --text-primary: #f1f5f9;
        --text-secondary: #94a3b8;
        --border-color: #334155;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: var(--main-bg); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }
    .dashboard-container { display: grid; grid-template-columns: 240px 1fr; min-height: 100vh; }

    /* --- Sidebar --- */
    .sidebar { background: var(--sidebar-bg); color: #fff; display: flex; flex-direction: column; padding: 24px 16px; position: fixed; left: 0; top: 0; height: 100%; width: 240px; z-index: 100; transition: transform 0.3s ease-in-out; }
    .sidebar-header { display: flex; align-items: center; gap: 12px; padding-bottom: 24px; margin-bottom: 16px; border-bottom: 1px solid var(--sidebar-bg-hover); }
    .sidebar-logo { width: 40px; height: 40px; background: var(--accent-blue); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; color: #ffffff; }
    .sidebar-header h1 { font-size: 1.1rem; font-weight: 600; color: #fff; }
    .nav-list { list-style: none; flex-grow: 1; }
    .nav-list a { color: #cbd5e1; text-decoration: none; display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 8px; font-weight: 500; transition: all 0.2s ease-in-out; margin-bottom: 4px; }
    .nav-list a:hover { background: var(--sidebar-bg-hover); color: #fff; }
    .nav-list a.active { background: var(--accent-blue); color: #fff; }
    .nav-icon { font-size: 1.2rem; }
    .sidebar-footer { border-top: 1px solid var(--sidebar-bg-hover); padding-top: 16px; }
    .user-profile { display: flex; align-items: center; gap: 12px; background: var(--sidebar-bg-hover); padding: 12px; border-radius: 8px; margin-bottom: 12px; }
    .user-avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--accent-blue); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.9rem; flex-shrink: 0; }
    .user-details .user-name { font-weight: 600; font-size: 0.9rem; }
    .user-details .user-email { font-size: 0.75rem; color: #94a3b8; }
    .logout-btn { width: 100%; background: none; border: none; color: #cbd5e1; display: flex; align-items: center; gap: 12px; padding: 12px 16px; font-size: 1rem; cursor: pointer; text-align: left; font-family: inherit; border-radius: 8px; transition: all 0.2s ease-in-out; }
    .logout-btn:hover { background: var(--accent-red); color: #fff; }

    .main-content { grid-column: 2 / 3; padding: 32px; }
    .main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; }
    .main-header h2 { font-size: 1.8rem; font-weight: 700; color: var(--text-primary); }
    .main-header p { color: var(--text-secondary); font-size: 1rem; }

    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 24px; margin-bottom: 32px; }
    .summary-link { text-decoration: none; color: inherit; }
    .summary-card { background: var(--card-bg); padding: 24px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-left: 4px solid; transition: all 0.3s; }
    .summary-card:hover { transform: translateY(-4px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
    .summary-card.blue { border-color: var(--accent-blue); }
    .summary-card.green { border-color: var(--accent-green); }
    .summary-card.yellow { border-color: var(--accent-yellow); }
    .summary-card.red { border-color: var(--accent-red); }
    .card-header { display: flex; align-items: center; gap: 16px; margin-bottom: 12px; }
    .card-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
    .blue .card-icon { background-color: #dbeafe; color: var(--accent-blue); }
    .green .card-icon { background-color: #d1fae5; color: var(--accent-green); }
    .yellow .card-icon { background-color: #fef3c7; color: var(--accent-yellow); }
    .red .card-icon { background-color: #fee2e2; color: var(--accent-red); }
    .card-title { color: var(--text-secondary); font-size: 0.9rem; font-weight: 500; }
    .card-value { font-size: 2.2rem; font-weight: 800; color: var(--text-primary); }
    
    .main-dashboard { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; }
    .dashboard-card { background: var(--card-bg); padding: 24px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); transition: background-color 0.3s; }
    .dashboard-card-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 20px; }
    .list-item { display: flex; align-items: center; gap: 16px; padding: 12px 0; border-bottom: 1px solid var(--border-color); }
    .list-item:last-child { border-bottom: none; }
    .list-item-icon { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1rem; background-color: var(--main-bg); transition: background-color 0.3s; }
    .list-item-details { flex-grow: 1; }
    .list-item-details strong { display: block; font-weight: 500; font-size: 0.9rem; }
    .list-item-details small { color: var(--text-secondary); font-size: 0.8rem; }
    .list-item-value { font-weight: 600; font-size: 0.9rem; }
    .list-item-value.high-priority { color: var(--accent-red); }
    .expense { color: var(--accent-red); }

    .alerta-amarelo { border-left: 3px solid var(--accent-yellow); padding-left: 12px; border-radius: 4px; }
    .alerta-vermelho { border-left: 3px solid var(--accent-red); padding-left: 12px; border-radius: 4px; }
    
    .mobile-menu-btn { display: none; background: none; border: none; font-size: 1.8rem; cursor: pointer; color: var(--text-primary); }
    .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 99; }
    .overlay.is-open { display: block; }
    @media (max-width: 1024px) { .main-dashboard { grid-template-columns: 1fr; } }
    @media (max-width: 768px) {
      .dashboard-container { grid-template-columns: 1fr; }
      .sidebar { transform: translateX(-100%); }
      .sidebar.is-open { transform: translateX(0); }
      .main-content { grid-column: 1 / 2; padding: 16px; }
      .mobile-menu-btn { display: block; }
      .main-header { gap: 16px; }
      .main-header div { flex-grow: 1; }
    }
  </style>
</head>
<body>

  <div class="dashboard-container">
    <nav class="sidebar" id="sidebar">
      <div>
        <div class="sidebar-header">
          <div class="sidebar-logo">S</div>
          <h1>SIGO Casa dos Reparos</h1>
        </div>
        <ul class="nav-list">
          <li><a href="painel.html" class="active"><span class="nav-icon">üè†</span> Painel</a></li>
          <li><a href="ordens-servico.html"><span class="nav-icon">üõ†Ô∏è</span> Ordens de Servi√ßo</a></li>
          <li><a href="clientes.html"><span class="nav-icon">üë•</span> Clientes</a></li>
          <li><a href="agendamentos.html"><span class="nav-icon">üìÖ</span> Agenda</a></li>
          <li><a href="estoque.html"><span class="nav-icon">üì¶</span> Estoque</a></li>
          <li><a href="contas_financeiro.html"><span class="nav-icon">üí∞</span> Financeiro</a></li>
          <li><a href="anotacoes.html"><span class="nav-icon">üìù</span> Anota√ß√µes</a></li>
          <li><a href="pecas.html"><span class="nav-icon">üî©</span> Pe√ßas para Pedir</a></li>
          <li><a href="impressao.html"><span class="nav-icon">üñ®Ô∏è</span> Impress√£o</a></li>
          <li><a href="configuracoes.html"><span class="nav-icon">‚öôÔ∏è</span> Configura√ß√µes</a></li>
        </ul>
      </div>
      <div class="sidebar-footer">
        <div class="user-profile">
          <div class="user-avatar" id="userAvatar">U</div>
          <div class="user-details">
            <span class="user-name" id="userName">Carregando...</span>
            <span class="user-email" id="userEmail">...</span>
          </div>
        </div>
        <button class="logout-btn" onclick="logout()">
          <span class="nav-icon">üö™</span> Sair do Sistema
        </button>
      </div>
    </nav>
    <div class="overlay" id="overlay"></div>

    <main class="main-content">
      <header class="main-header">
        <div>
          <h2 id="greeting">Boa tarde, Usu√°rio!</h2>
          <p id="currentDate">Sexta-feira, 10 de Outubro de 2025</p>
        </div>
        <button class="mobile-menu-btn" id="mobileMenuBtn">‚ò∞</button>
      </header>

      <section class="summary-grid">
        <a href="ordens-servico.html" class="summary-link">
          <div class="summary-card blue">
            <div class="card-header"><div class="card-icon">üõ†Ô∏è</div><span class="card-title">OS em Andamento</span></div>
            <p class="card-value" id="stat-os-andamento">0</p>
          </div>
        </a>
        <a href="contas_financeiro.html" class="summary-link">
          <div class="summary-card green">
            <div class="card-header"><div class="card-icon">üíµ</div><span class="card-title">Receita do Dia</span></div>
            <p class="card-value" id="stat-receita-dia">R$ 0,00</p>
          </div>
        </a>
        <a href="agendamentos.html" class="summary-link">
          <div class="summary-card yellow">
            <div class="card-header"><div class="card-icon">üìÖ</div><span class="card-title">Agendamentos Hoje</span></div>
            <p class="card-value" id="stat-agendamentos-hoje">0</p>
          </div>
        </a>
        <a href="estoque.html" class="summary-link">
          <div class="summary-card red">
            <div class="card-header"><div class="card-icon">üì¶</div><span class="card-title">Estoque Baixo</span></div>
            <p class="card-value" id="stat-estoque-baixo">0</p>
          </div>
        </a>
      </section>

      <section class="main-dashboard">
        <div class="dashboard-left">
          <div class="dashboard-card" style="margin-bottom: 24px;">
             <h3 class="dashboard-card-title">üìÖ Agenda do Dia</h3>
             <div id="lista-agenda-dia"><p style="text-align: center; color: var(--text-secondary);">Carregando agendamentos...</p></div>
          </div>
          <a href="pecas.html" style="text-decoration: none;">
            <div class="dashboard-card">
              <h3 class="dashboard-card-title">üî© Pe√ßas Urgentes para Pedir</h3>
              <div id="lista-pecas-pedir"><p style="text-align: center; color: var(--text-secondary);">Verificando pe√ßas...</p></div>
            </div>
          </a>
        </div>
        <div class="dashboard-right">
          <div class="dashboard-card" style="margin-bottom: 24px;">
            <h3 class="dashboard-card-title">‚ö†Ô∏è Contas a Vencer</h3>
            <div id="lista-contas-vencer"><p style="text-align: center; color: var(--text-secondary);">Verificando contas...</p></div>
          </div>
          <div class="dashboard-card">
            <h3 class="dashboard-card-title">üìù Anota√ß√µes Recentes</h3>
            <div id="lista-anotacoes"><p style="text-align: center; color: var(--text-secondary);">Carregando anota√ß√µes...</p></div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="utils.js"></script>

  <script>
    protegerPagina();

    // L√ìGICA DE RESPONSIVIDADE (MENU MOBILE)
    const sidebar = document.getElementById('sidebar');
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const overlay = document.getElementById('overlay');
    mobileMenuBtn.addEventListener('click', () => { sidebar.classList.toggle('is-open'); overlay.classList.toggle('is-open'); });
    overlay.addEventListener('click', () => { sidebar.classList.remove('is-open'); overlay.classList.remove('is-open'); });

    // --- VARI√ÅVEIS GLOBAIS ---
    const greetingElement = document.getElementById('greeting');
    const dateElement = document.getElementById('currentDate');
    const refs = {
      os: database.ref("ordens_servico"),
      transacoes: database.ref("transacoes"),
      agendamentos: database.ref("agendamentos"),
      estoque: database.ref("estoque"),
      anotacoes: database.ref("anotacoes"),
      pecasPedir: database.ref("pecas_pedir"), // Nova refer√™ncia
    };
    const configRef = database.ref('configuracoes');
    let dashboardData = {};

    // --- AUTENTICA√á√ÉO E INICIALIZA√á√ÉO ---
    auth.onAuthStateChanged(user => {
      if (user) {
        const nome = user.displayName || user.email.split('@')[0];
        const iniciais = nome.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        document.getElementById('userName').textContent = nome;
        document.getElementById('userEmail').textContent = user.email;
        document.getElementById('userAvatar').textContent = iniciais;
        updateHeader();
        
        configRef.on('value', (snapshot) => {
            const config = snapshot.val() || {};
            if (config.darkMode) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
        });

        Object.keys(refs).forEach(key => {
            refs[key].on("value", snapshot => {
                const data = snapshot.val() || {};
                updateDashboard(key, data);
            });
        });
      }
    });

    // --- FUN√á√ïES DE ATUALIZA√á√ÉO DA INTERFACE ---

    function updateHeader() {
        const agora = new Date();
        const hora = agora.getHours();
        let cumprimento = "Bom dia";
        if (hora >= 12 && hora < 18) { cumprimento = "Boa tarde"; }
        else if (hora >= 18 || hora < 5) { cumprimento = "Boa noite"; }
        
        const nomeUsuario = auth.currentUser ? (auth.currentUser.displayName || auth.currentUser.email.split('@')[0]) : "Usu√°rio";
        greetingElement.textContent = `${cumprimento}, ${nomeUsuario}!`;
        
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        dateElement.textContent = agora.toLocaleDateString('pt-BR', options);
    }

    function updateDashboard(key, data) {
        dashboardData[key] = data;
        updateSummaryCards();
        updateAgendaDoDia();
        updateContasAVencer();
        updateAnotacoes();
        updatePecasPedir(); // Nova fun√ß√£o chamada
    }

    function formatarMoeda(valor) {
      return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor || 0);
    }

    function updateSummaryCards() {
        const hoje = new Date().toISOString().slice(0, 10);
        
        const osEmAndamento = Object.values(dashboardData.os || {}).filter(os => ['aguardando', 'em_andamento'].includes(os.statusOS)).length;
        document.getElementById('stat-os-andamento').textContent = osEmAndamento;

        const receitaDia = Object.values(dashboardData.transacoes || {})
            .filter(t => t.tipo === 'entrada' && t.dataTransacao === hoje && t.statusTransacao === 'pago')
            .reduce((sum, t) => sum + parseFloat(t.valor), 0);
        document.getElementById('stat-receita-dia').textContent = formatarMoeda(receitaDia);

        const agendamentosHoje = Object.values(dashboardData.agendamentos || {})
            .filter(ag => ag.dataAgendamento === hoje).length;
        document.getElementById('stat-agendamentos-hoje').textContent = agendamentosHoje;

        const estoqueBaixo = Object.values(dashboardData.estoque || {})
            .filter(item => item.quantidade <= item.estoqueMinimo).length;
        document.getElementById('stat-estoque-baixo').textContent = estoqueBaixo;
    }

    function updateAgendaDoDia() {
        if (!dashboardData.agendamentos) return;
        const listaAgenda = document.getElementById('lista-agenda-dia');
        const hojeString = new Date().toISOString().slice(0, 10);

        const agendamentosHoje = Object.values(dashboardData.agendamentos || {})
            .filter(ag => ag.dataAgendamento === hojeString)
            .sort((a, b) => a.horaAgendamento.localeCompare(b.horaAgendamento));

        if (agendamentosHoje.length === 0) {
            listaAgenda.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Nenhum agendamento para hoje.</p>';
            return;
        }

        listaAgenda.innerHTML = '';
        agendamentosHoje.forEach(ag => {
            const itemHTML = `
                <div class="list-item">
                    <div class="list-item-icon">üóìÔ∏è</div>
                    <div class="list-item-details">
                        <strong>${ag.clienteNome}</strong>
                        <small>${ag.tipoServico}</small>
                    </div>
                    <span class="list-item-value">${ag.horaAgendamento}</span>
                </div>`;
            listaAgenda.innerHTML += itemHTML;
        });
    }

    function updatePecasPedir() {
        if (!dashboardData.pecasPedir) return;
        const listaPecas = document.getElementById('lista-pecas-pedir');

        const pecas = Object.values(dashboardData.pecasPedir || {})
            .filter(p => p.status !== 'pedido') // Exemplo de filtro, ajuste conforme sua necessidade
            .sort((a, b) => (b.prioridade === 'alta' ? 1 : -1) - (a.prioridade === 'alta' ? 1 : -1)) // Prioridade alta primeiro
            .slice(0, 4);

        if (pecas.length === 0) {
            listaPecas.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Nenhuma pe√ßa urgente.</p>';
            return;
        }

        listaPecas.innerHTML = '';
        pecas.forEach(peca => {
            const isHighPriority = peca.prioridade === 'alta';
            const itemHTML = `
                <div class="list-item">
                    <div class="list-item-icon">üî©</div>
                    <div class="list-item-details">
                        <strong>${peca.nomePeca}</strong>
                        <small>Fornecedor: ${peca.fornecedor || 'N√£o definido'}</small>
                    </div>
                    ${isHighPriority ? '<span class="list-item-value high-priority">Urgente</span>' : ''}
                </div>`;
            listaPecas.innerHTML += itemHTML;
        });
    }


    function updateContasAVencer() {
        if (!dashboardData.transacoes) return;
        const listaContas = document.getElementById('lista-contas-vencer');

        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);

        const contasPendentes = Object.values(dashboardData.transacoes || {})
            .filter(t => t.tipo === 'saida' && t.statusTransacao === 'pendente' && t.dataVencimento)
            .sort((a,b) => new Date(a.dataVencimento) - new Date(b.dataVencimento));
            
        let htmlContas = '';
        let count = 0;
        contasPendentes.forEach(conta => {
            if(count >= 4) return; // Limita a 4 itens
            const dataVenc = new Date(conta.dataVencimento + 'T00:00:00');
            const diffTime = dataVenc - hoje;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            let classeAlerta = '';
            if (diffDays <= 0) {
                classeAlerta = 'alerta-vermelho'; // Vencido ou vence hoje
            } else if (diffDays <= 3) {
                classeAlerta = 'alerta-amarelo'; // Vence em at√© 3 dias
            }
            
            if(classeAlerta) {
                const itemHTML = `
                    <div class="list-item ${classeAlerta}">
                        <div class="list-item-details">
                            <strong>${conta.descricao}</strong>
                            <small>Vence em: ${dataVenc.toLocaleDateString('pt-BR')}</small>
                        </div>
                        <span class="list-item-value expense">${formatarMoeda(conta.valor)}</span>
                    </div>`;
                htmlContas += itemHTML;
                count++;
            }
        });
        
        if(htmlContas === '') {
             listaContas.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Nenhuma conta vencendo nos pr√≥ximos dias.</p>';
        } else {
            listaContas.innerHTML = htmlContas;
        }
    }

    function updateAnotacoes() {
        if (!dashboardData.anotacoes) return;
        const listaAnotacoes = document.getElementById('lista-anotacoes');

        const anotacoes = Object.values(dashboardData.anotacoes || {})
            .filter(a => !a.arquivada)
            .sort((a,b) => new Date(b.criadoEm) - new Date(a.criadoEm))
            .slice(0, 4);

        if (anotacoes.length === 0) {
            listaAnotacoes.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Nenhuma anota√ß√£o ativa.</p>';
            return;
        }

        listaAnotacoes.innerHTML = '';
        anotacoes.forEach(task => {
            const itemHTML = `
                <div class="list-item">
                    <div class="list-item-icon">üìù</div>
                    <div class="list-item-details">
                        <strong>${task.texto.substring(0, 40)}${task.texto.length > 40 ? '...' : ''}</strong>
                    </div>
                </div>`;
            listaAnotacoes.innerHTML += itemHTML;
        });
    }

  </script>

</body>
</html>
